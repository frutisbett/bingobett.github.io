<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BingoBett</title>
<script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=sbO6SkZAoBAd8bHIixIsBWkRAXZjgH25Rb5bMF56wdI7iMA9VKxRWPdb2qM8NuMo6BmvVOooQUkoF2IekWl28Wkv5MoF8ln7sLPy99E8tiOdOUUMuPTqaJ-ym7IzSmdh" charset="UTF-8"></script><script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=7ebII8iazCFmgOCAv4_83suT-WrIwxKHeljjm-cU6y5OqpZge1U-lViPdYqbPTBo_Re1HfawevBmdpqTiqWo22ZcNBL72Clk7DYY91pwWPof2L4UA3my_p0sOeVInZ_L" charset="UTF-8"></script><script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=GSSrfiSffx0kH7sW4myJ8MM6WVBQeRaifiOyZTd7q3V0DyBg9bNHwTh3v39YezmzSfAw3b2bnMIM-9fBhOF-lKQBANKCKYv8JIpvE_oWS4xc6zlQXlwY5LZPCzYB73IfNWYdHIHNq6AQ3mKbHn8HtwWKLrp3FgoBJpO1TXC_JXwNO0kxaBIkG-yGDRqO5qWKzwFPPXNt4PQgcPGCeFt4vAHBkxY9Vkn_xpHkLPsYeNqCNkgYiVKXqC4nTqVRz5J-hcgO_Z1kZlQHgMJqQ9Q5F5Y9PeQkkZD5PY8xHhPYZ3WJJbx0wOlJKpFQJQOQRyMKqBaQZq7QcYmgDq8qkPYqhGY_3WQzzHQHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQqHQQQ"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #1a1a1a, #444);
    color: #fff;
    margin: 0; padding: 20px;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh;
  }
  .modal-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .modal {
    background: #333;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    color: white;
    min-width: 300px;
  }
  .modal input {
    margin: 10px 0;
    padding: 10px;
    font-size: 16px;
    border-radius: 5px;
    border: none;
    width: 200px;
  }
  .modal button {
    padding: 10px 20px;
    font-size: 16px;
    background: #4caf50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin: 5px;
  }
  .modal button.cancel {
    background: #f44336;
  }
  .info-bar {
    display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
    margin-bottom: 15px;
  }
  .info-bar > div {
    font-size: 18px;
  }
  .slot-machine {
    display: grid;
    grid-template-columns: repeat(5, 18vw);
    grid-template-rows: repeat(4, 12vw);
    gap: 2vw;
    background: #222;
    padding: 4vw 2vw;
    border-radius: 4vw;
    box-shadow: 0 0 4vw #0f0;
    max-width: 98vw;
    min-width: 320px;
    overflow: hidden;
  }
  .slot {
    background: #000;
    border-radius: 2vw;
    font-size: 8vw;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: inset 0 0 2vw #0f0;
    transition: background-color 0.3s, transform 0.3s;
    position: relative;
    min-width: 0;
    min-height: 0;
    overflow: hidden;
  }
  
  /* Spinning animation for slots */
  .slot.spinning {
    background: linear-gradient(180deg, #000, #333, #666, #333, #000);
    background-size: 100% 500%;
    animation: slotSpin 0.15s linear infinite;
    overflow: hidden;
  }
  
  .slot.spinning::before {
    content: "üçíüçãüçäüçâüçáüçìüççü•ùüçåü••üéÅüíé‚≠êüÉèüëëüí∞";
    position: absolute;
    top: -200%;
    left: 0;
    width: 100%;
    height: 500%;
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    align-items: center;
    animation: reelSpin 0.1s linear infinite;
    font-size: 6vw;
    line-height: 1;
  }
  
  @keyframes slotSpin {
    0% { 
      background-position: 0% 0%;
      transform: rotateY(0deg);
    }
    25% { 
      background-position: 0% 25%;
      transform: rotateY(5deg);
    }
    50% { 
      background-position: 0% 50%;
      transform: rotateY(0deg);
    }
    75% { 
      background-position: 0% 75%;
      transform: rotateY(-5deg);
    }
    100% { 
      background-position: 0% 100%;
      transform: rotateY(0deg);
    }
  }
  
  @keyframes reelSpin {
    0% { transform: translateY(0%); }
    100% { transform: translateY(-100%); }
  }
  
  .slot.win {
    background-color: gold;
    color: black;
    box-shadow: 0 0 15px 5px gold;
    animation: winPulse 1s infinite alternate;
  }
  @keyframes winPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.1); }
  }
  .slot.big-win {
    animation: megaWinPulse 0.4s alternate infinite;
    background: linear-gradient(90deg, gold, orange, gold);
    color: black;
  }
  @keyframes megaWinPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.2); }
  }
  button {
    margin-top: 15px;
    padding: 2vw 4vw;
    font-size: 4vw;
    cursor: pointer;
    border-radius: 12px;
    border: none;
    background: #4caf50;
    color: white;
    box-shadow: 0 5px #388e3c;
    transition: background 0.3s;
  }
  button:active {
    box-shadow: 0 2px #388e3c;
    transform: translateY(3px);
  }
  button:disabled {
    background: #666;
    cursor: not-allowed;
    box-shadow: 0 2px #555;
  }
  .controls {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
  }
  .message {
    margin-top: 20px;
    font-size: 4vw;
    min-height: 10vw;
    white-space: pre-line;
    color: #ff0;
    max-width: 98vw;
    text-align: center;
  }
  .bank-jackpot {
    margin: 10px 0;
    font-size: 4vw;
  }
  .balance-actions {
    margin: 12px 0;
  }
  .balance-actions input {
    width: 40vw;
    max-width: 140px;
    font-size: 4vw;
    padding: 2vw;
    border-radius: 8px;
    border: none;
    margin-right: 2vw;
    min-width: 0;
    box-sizing: border-box;
  }
  #withdrawMsg {
    color: #ff0;
    min-height: 24px;
    font-size: 17px;
    margin-top: 6px;
    text-align: center;
  }
  #botChat {
    width: 98vw;
    max-width: 420px;
    max-height: 40vw;
    overflow-y: auto;
    background: #111;
    color: #0f0;
    font-family: monospace;
    font-size: 3.5vw;
    padding: 2vw;
    border-radius: 2vw;
    margin-top: 5vw;
    border: 1px solid #0f0;
  }
  .bot-message {
    margin: 3px 0;
    padding: 2px;
    border-bottom: 1px dotted #0f03;
  }
  .replenish-buttons {
    margin: 15px 0;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .replenish-btn {
    padding: 10px 20px;
    font-size: 4vw;
    background: #e62117;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .replenish-btn:hover {
    background: #cc1f15;
  }
  
  /* Withdrawal button styling */
  .withdraw-btn {
    padding: 10px 20px;
    font-size: 4vw;
    background: #ff9800;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin: 10px;
  }
  .withdraw-btn:hover {
    background: #f57c00;
  }
  
  /* –ú–∏–Ω–∏-–∏–≥—Ä–∞ */
  .mini-game-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999;
  }
  .mini-game-content {
    background: #232323;
    border-radius: 2vw;
    padding: 5vw 3vw 4vw 3vw;
    color: #fff;
    min-width: 60vw;
    box-shadow: 0 0 4vw #000;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .boxes {
    display: flex;
    gap: 10px;
    margin: 20px 0;
  }
  .box {
    width: 20vw;
    max-width: 100px;
    height: 20vw;
    max-height: 100px;
    background: #000;
    border-radius: 2vw;
    font-size: 10vw;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: inset 0 0 2vw #0f0;
    transition: background-color 0.3s, transform 0.3s;
    position: relative;
    cursor: pointer;
  }
  .box.selected {
    background-color: #4caf50;
    color: white;
  }
  .box.win {
    background-color: green;
    color: white;
  }
  .box.lose {
    background-color: red;
    color: white;
  }
  .mini-game-msg {
    font-size: 18px;
    margin-bottom: 10px;
  }
  .close-btn {
    font-size: 18px;
    padding: 10px 20px;
    border-radius: 5px;
    background-color: #ff4500;
    color: white;
    cursor: pointer;
    border: none;
  }
  @media (max-width: 600px) {
    .slot-machine {
      grid-template-columns: repeat(5, 16vw);
      grid-template-rows: repeat(4, 10vw);
      padding: 2vw 1vw;
    }
    .slot {
      font-size: 7vw;
    }
    #botChat, .mini-game-content {
      width: 96vw;
      max-width: 100vw;
      font-size: 3.5vw;
    }
    .box {
      width: 25vw;
      height: 25vw;
      font-size: 12vw;
    }
    .message {
      max-width: 98vw;
      font-size: 4vw;
    }
    .info-bar > div {
      font-size: 4vw;
    }
    .bank-jackpot {
      font-size: 4vw;
    }
  }
</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<div id="usernameModal" class="modal-bg" style="display:none;">
  <div class="modal">
    <div>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –¥–ª—è –∏–≥—Ä—ã:</div>
    <input id="usernameInput" maxlength="32" autocomplete="off">
    <button id="usernameOkBtn">OK</button>
  </div>
</div>

<!-- Withdrawal Modal -->
<div id="withdrawModal" class="modal-bg" style="display:none;">
  <div class="modal">
    <h3>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h3>
    <div>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</div>
    <input id="cardNumberInput" maxlength="19" placeholder="1234 5678 9012 3456" autocomplete="off">
    <div>–°—É–º–º–∞ –∫ –≤—ã–≤–æ–¥—É: <span id="withdrawAmount"></span> ‚ÇΩ</div>
    <div style="margin-top: 15px;">
      <button id="confirmWithdrawBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      <button id="cancelWithdrawBtn" class="cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <div id="withdrawError" style="color: #ff4444; margin-top: 10px; font-size: 14px;"></div>
  </div>
</div>

<h1>BingoBett</h1>
<div class="info-bar">
  <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="username"></span></div>
  <div>–ë–∞–ª–∞–Ω—Å: <span id="balanceDisplay">555 ‚ÇΩ</span></div>
  <div>–°—Ç–∞–≤–∫–∞: <button id="betMinus">-</button> <span id="betAmount">10</span> ‚ÇΩ <button id="betPlus">+</button></div>
</div>
<div id="freeSpinsDisplay">–§—Ä–∏—Å–ø–∏–Ω—ã: 55</div>

<div id="withdrawMsg"></div>

<div class="bank-jackpot">
  –î–∂–µ–∫–ø–æ—Ç: <span id="jackpotDisplay">2 200 453 ‚ÇΩ</span>
</div>

<div class="replenish-buttons">
  <button class="replenish-btn" data-amount="50">50 ‚ÇΩ</button>
  <button class="replenish-btn" data-amount="300">300 ‚ÇΩ</button>
  <button class="replenish-btn" data-amount="500">500 ‚ÇΩ</button>
  <button class="replenish-btn" data-amount="800">800 ‚ÇΩ</button>
  <button class="withdraw-btn" id="withdrawBtn">–í—ã–≤–µ—Å—Ç–∏ –≤—ã–∏–≥—Ä—ã—à</button>
</div>

<div class="slot-machine" id="slotMachine"></div>

<div class="controls">
  <button id="spinButton">–í—Ä–∞—â–∞—Ç—å üé∞</button>
  <button id="autoSpinButton">–ê–≤—Ç–æ—Å–ø–∏–Ω ‚ñ∂Ô∏è</button>
  <button id="stopAutoSpinButton" style="display:none;">–°—Ç–æ–ø –∞–≤—Ç–æ—Å–ø–∏–Ω ‚èπ</button>
</div>

<div class="message" id="message"></div>

<div id="botChat">
  <b>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏:</b><br>
</div>

<!-- –ú–∏–Ω–∏-–∏–≥—Ä–∞ -->
<div class="mini-game-overlay" id="miniGameOverlay" style="display:none;">
  <div class="mini-game-content">
    <h2>–ú–∏–Ω–∏-–∏–≥—Ä–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É!</h2>
    <div class="boxes">
      <div class="box" data-box="1">üéÅ</div>
      <div class="box" data-box="2">üéÅ</div>
      <div class="box" data-box="3">üéÅ</div>
    </div>
    <div class="mini-game-msg" id="miniGameMsg"></div>
    <button class="close-btn" id="closeMiniGame">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
  // --- Telegram WebApp SDK ---
  let tgUser = null;
  if (window.Telegram && Telegram.WebApp) {
    Telegram.WebApp.ready();
    if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
      tgUser = Telegram.WebApp.initDataUnsafe.user;
    }
  }

  // --- Game Parameters ---
  const columns = 5;
  const rows = 4;
  const MIN_BET = 10;
  const MAX_BET = 80;
  
  const reels = [
    ["üçí","üçã","üçä","üçâ","üçá","üçì","üçç","ü•ù","üçå","ü••","üéÅ","üíé","üçã","üçä","üçâ","üçá","üçì","ü••","‚≠ê","üÉè","üëë"],
    ["üçã","üçä","üçâ","üçá","üçì","üçç","ü•ù","üçå","ü••","üéÅ","üíé","üçí","üçã","üçä","üçâ","üçá","üçì","üçç","‚≠ê","üÉè"],
    ["üçä","üçâ","üçá","üçì","üçç","ü•ù","üçå","ü••","üéÅ","üíé","üçí","üçã","üçä","üçâ","üçá","üçì","üçç","‚≠ê","üÉè","üí∞"],
    ["üçâ","üçá","üçì","üçç","ü•ù","üçå","ü••","üéÅ","üíé","üçí","üçã","üçä","üçâ","üçá","üçì","üçç","‚≠ê","üÉè"],
    ["üçá","üçì","üçç","ü•ù","üçå","ü••","üéÅ","üíé","üçí","üçã","üçä","üçâ","üçá","üçì","üçç","ü•ù","‚≠ê","üÉè"]
  ];
  
  const payTable = {
    "üçí": {3:5, 4:10, 5:20},
    "üçã": {3:5, 4:10, 5:20},
    "üçä": {3:5, 4:10, 5:20},
    "üçâ": {3:5, 4:10, 5:20},
    "üçá": {3:5, 4:10, 5:20},
    "üçì": {3:7, 4:14, 5:28},
    "üçç": {3:7, 4:14, 5:28},
    "ü•ù": {3:10, 4:20, 5:40},
    "üçå": {3:10, 4:20, 5:40},
    "ü••": {3:12, 4:24, 5:48},
    "üéÅ": {3:15, 4:30, 5:60},
    "üíé": {3:20, 4:40, 5:80},
    "‚≠ê": {3:25, 4:50, 5:100},
    "üÉè": {3:30, 4:60, 5:120},
    "üëë": {3:50, 4:100, 5:200},
    "üí∞": {3:100, 4:200, 5:500}
  };

  // --- Game State ---
  let balance = parseFloat(localStorage.getItem('slotBalance')) || 555;
  let bet = parseInt(localStorage.getItem('slotBet')) || 10;
  let jackpot = parseFloat(localStorage.getItem('jackpot')) || 2200453;
  let isSpinning = false;
  let autoSpinActive = false;
  let autoSpinInterval = null;
  let slotElements = [];

  // --- User Management ---
  let username = localStorage.getItem('slotUsername') || '';
  
  function setUsername(name) {
    username = name;
    localStorage.setItem('slotUsername', name);
    document.getElementById('username').textContent = name;
  }

  // Initialize user
  if (tgUser && tgUser.first_name) {
    setUsername(tgUser.first_name + (tgUser.last_name ? " " + tgUser.last_name : ""));
  } else if (!username) {
    document.getElementById('usernameModal').style.display = '';
    document.getElementById('usernameInput').focus();
    document.getElementById('usernameOkBtn').onclick = function() {
      let val = document.getElementById('usernameInput').value.trim();
      if (val.length > 0) {
        setUsername(val);
        document.getElementById('usernameModal').style.display = 'none';
      }
    };
    document.getElementById('usernameInput').onkeydown = function(e) {
      if (e.key === "Enter") document.getElementById('usernameOkBtn').click();
    };
  } else {
    setUsername(username);
  }

  // --- Free Spins Management (Fixed and Enhanced) ---
  class FreeSpinsManager {
    constructor() {
      this.initializeFreeSpins();
      this.checkExpiration();
    }

    initializeFreeSpins() {
      const registrationTimestamp = localStorage.getItem('registrationTimestamp');
      if (!registrationTimestamp) {
        localStorage.setItem('freeSpins', '55');
        localStorage.setItem('registrationTimestamp', Date.now().toString());
      }
    }

    checkExpiration() {
      const registrationTime = Number(localStorage.getItem('registrationTimestamp'));
      const currentTime = Date.now();
      const twentyFourHours = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
      
      if (currentTime - registrationTime > twentyFourHours) {
        localStorage.setItem('freeSpins', '0');
        this.displayFreeSpins();
      }
    }

    getFreeSpins() {
      this.checkExpiration();
      return parseInt(localStorage.getItem('freeSpins') || '0');
    }

    useFreeSpins(count = 1) {
      let currentSpins = this.getFreeSpins();
      if (currentSpins >= count) {
        currentSpins -= count;
        localStorage.setItem('freeSpins', currentSpins.toString());
        this.displayFreeSpins();
        return true;
      }
      return false;
    }

    displayFreeSpins() {
      const freeSpins = this.getFreeSpins();
      document.getElementById('freeSpinsDisplay').textContent = `–§—Ä–∏—Å–ø–∏–Ω—ã: ${freeSpins}`;
    }

    getTimeUntilExpiration() {
      const registrationTime = Number(localStorage.getItem('registrationTimestamp'));
      const currentTime = Date.now();
      const twentyFourHours = 24 * 60 * 60 * 1000;
      const timeLeft = twentyFourHours - (currentTime - registrationTime);
      
      if (timeLeft <= 0) return "–ò—Å—Ç–µ–∫–ª–∏";
      
      const hours = Math.floor(timeLeft / (60 * 60 * 1000));
      const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
      
      return `${hours}—á ${minutes}–º`;
    }
  }

  const freeSpinsManager = new FreeSpinsManager();

  // --- Withdrawal System ---
  function initializeWithdrawal() {
    const withdrawBtn = document.getElementById('withdrawBtn');
    const withdrawModal = document.getElementById('withdrawModal');
    const cardNumberInput = document.getElementById('cardNumberInput');
    const confirmWithdrawBtn = document.getElementById('confirmWithdrawBtn');
    const cancelWithdrawBtn = document.getElementById('cancelWithdrawBtn');
    const withdrawError = document.getElementById('withdrawError');

    // Format card number input
    cardNumberInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
      let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
      e.target.value = formattedValue;
    });

    withdrawBtn.addEventListener('click', function() {
      if (balance <= 40000) {
        showMessage('–í—ã–≤–æ–¥ –≤–æ–∑–º–æ–∂–µ–Ω –æ—Ç 40 000 —Ä—É–±–ª–µ–π');
        return;
      }
      
      const withdrawableAmount = balance - 40000;
      document.getElementById('withdrawAmount').textContent = withdrawableAmount.toFixed(2);
      cardNumberInput.value = '';
      withdrawError.textContent = '';
      withdrawModal.style.display = '';
      cardNumberInput.focus();
    });

    confirmWithdrawBtn.addEventListener('click', function() {
      const cardNumber = cardNumberInput.value.replace(/\s/g, '');
      
      if (!validateCardNumber(cardNumber)) {
        withdrawError.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã (16 —Ü–∏—Ñ—Ä)';
        return;
      }

      // Calculate withdrawable amount (all above 40,000)
      const withdrawAmount = balance - 40000;
      balance = 40000; // Keep 40,000 on balance
      updateBalance();
      
      withdrawModal.style.display = 'none';
      showMessage(`–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ ${withdrawAmount.toFixed(2)} ‚ÇΩ –ø—Ä–∏–Ω—è—Ç–∞!\n–°—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ—Å—Ç—É–ø—è—Ç –Ω–∞ –∫–∞—Ä—Ç—É **** **** **** ${cardNumber.slice(-4)} –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.`);
      
      // Add to bot chat
      addBotMessage(`${username} –≤—ã–≤–µ–ª ${withdrawAmount.toFixed(2)} ‚ÇΩ`);
    });

    cancelWithdrawBtn.addEventListener('click', function() {
      withdrawModal.style.display = 'none';
    });
  }

  function validateCardNumber(cardNumber) {
    return /^\d{16}$/.test(cardNumber);
  }

  // --- Slot Machine Animation System ---
  function createSpinningAnimation(slotElement, finalSymbol, duration) {
    let spinCount = 0;
    const maxSpins = Math.floor(duration / 80); // Change symbol every 80ms
    
    slotElement.classList.add('spinning');
    slotElement.textContent = ''; // Hide text during spinning
    
    const spinInterval = setInterval(() => {
      // Show random symbol during spinning
      if (!slotElement.classList.contains('spinning')) return;
      
      const randomReel = reels[Math.floor(Math.random() * reels.length)];
      const randomSymbol = randomReel[Math.floor(Math.random() * randomReel.length)];
      
      // Temporarily show symbol through the spinning effect
      spinCount++;
      if (spinCount >= maxSpins) {
        clearInterval(spinInterval);
        slotElement.classList.remove('spinning');
        slotElement.textContent = finalSymbol;
      }
    }, 80);
    
    return new Promise(resolve => {
      setTimeout(() => {
        slotElement.classList.remove('spinning');
        slotElement.textContent = finalSymbol;
        resolve();
      }, duration);
    });
  }

  // --- Bot Chat Updates ---
  const botMessages = [
    "–ê–Ω–Ω–∞ –ö. –≤—ã–∏–≥—Ä–∞–ª–∞ 450 ‚ÇΩ –≤ —Å–ª–æ—Ç–∞—Ö!",
    "–ú–∞–∫—Å–∏–º –†. —Å–æ—Ä–≤–∞–ª –¥–∂–µ–∫–ø–æ—Ç 15,000 ‚ÇΩ!",
    "–ï–ª–µ–Ω–∞ –í. –≤—ã–∏–≥—Ä–∞–ª–∞ 820 ‚ÇΩ!",
    "–ò–≥–æ—Ä—å –°. –ø–æ–ª—É—á–∏–ª –±–æ–Ω—É—Å 1,200 ‚ÇΩ!",
    "–ú–∞—Ä–∏—è –ü. –≤—ã–∏–≥—Ä–∞–ª–∞ 650 ‚ÇΩ –≤ –º–∏–Ω–∏-–∏–≥—Ä–µ!",
    "–ê–ª–µ–∫—Å–µ–π –ö. —Å–æ—Ä–≤–∞–ª –∫—É—à 3,400 ‚ÇΩ!",
    "–û–ª—å–≥–∞ –ù. –≤—ã–∏–≥—Ä–∞–ª–∞ 780 ‚ÇΩ!",
    "–î–º–∏—Ç—Ä–∏–π –õ. –ø–æ–ª—É—á–∏–ª 2,100 ‚ÇΩ!",
    "–ù–∞—Ç–∞–ª—å—è –ú. –≤—ã–∏–≥—Ä–∞–ª–∞ 920 ‚ÇΩ!",
    "–°–µ—Ä–≥–µ–π –ë. —Å–æ—Ä–≤–∞–ª –¥–∂–µ–∫–ø–æ—Ç 8,500 ‚ÇΩ!"
  ];

  function addBotMessage(message) {
    const botChat = document.getElementById('botChat');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'bot-message';
    messageDiv.textContent = `${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})} - ${message}`;
    botChat.appendChild(messageDiv);
    botChat.scrollTop = botChat.scrollHeight;
    
    // Keep only last 20 messages
    while (botChat.children.length > 21) { // +1 for the header
      botChat.removeChild(botChat.children[1]);
    }
  }

  function startBotMessages() {
    setInterval(() => {
      if (Math.random() < 0.3) { // 30% chance every interval
        const randomMessage = botMessages[Math.floor(Math.random() * botMessages.length)];
        addBotMessage(randomMessage);
      }
    }, 8000); // Every 8 seconds
  }

  // --- Game Logic ---
  function createSlotMachine() {
    const slotMachine = document.getElementById('slotMachine');
    slotMachine.innerHTML = '';
    slotElements = [];
    
    for (let i = 0; i < rows * columns; i++) {
      const slot = document.createElement('div');
      slot.className = 'slot';
      slot.textContent = 'üçí';
      slotMachine.appendChild(slot);
      slotElements.push(slot);
    }
  }

  function updateBalance() {
    document.getElementById('balanceDisplay').textContent = balance.toFixed(2) + ' ‚ÇΩ';
    localStorage.setItem('slotBalance', balance.toString());
  }

  function updateJackpot() {
    document.getElementById('jackpotDisplay').textContent = new Intl.NumberFormat('ru-RU').format(jackpot) + ' ‚ÇΩ';
    localStorage.setItem('jackpot', jackpot.toString());
  }

  function showMessage(text) {
    document.getElementById('message').textContent = text;
    setTimeout(() => {
      document.getElementById('message').textContent = '';
    }, 5000);
  }

  async function spin() {
    if (isSpinning) return;
    
    const currentBet = bet;
    const freeSpins = freeSpinsManager.getFreeSpins();
    let usingFreeSpins = false;

    // Check if player should use free spins
    if (freeSpins > 0) {
      usingFreeSpins = confirm(`–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—Ä–∏—Å–ø–∏–Ω? (–û—Å—Ç–∞–ª–æ—Å—å: ${freeSpins})`);
      if (!usingFreeSpins && balance < currentBet) {
        showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Å—Ç–∞–≤–∫–∏');
        return;
      }
    } else if (balance < currentBet) {
      showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Å—Ç–∞–≤–∫–∏');
      return;
    }

    isSpinning = true;
    document.getElementById('spinButton').disabled = true;
    document.getElementById('autoSpinButton').disabled = true;

    // Deduct bet or free spin
    if (usingFreeSpins) {
      freeSpinsManager.useFreeSpins(1);
      showMessage('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—Ä–∏—Å–ø–∏–Ω!');
    } else {
      balance -= currentBet;
      updateBalance();
    }

    // Add to jackpot
    jackpot += currentBet * 0.1;
    updateJackpot();

    // Clear previous win highlights
    slotElements.forEach(slot => {
      slot.classList.remove('win', 'big-win');
    });

    // Generate spin results
    const results = [];
    for (let col = 0; col < columns; col++) {
      const reel = reels[col];
      const columnResults = [];
      for (let row = 0; row < rows; row++) {
        columnResults.push(reel[Math.floor(Math.random() * reel.length)]);
      }
      results.push(columnResults);
    }

    // Start spinning animation for all slots with staggered timing
    const animationPromises = [];
    for (let col = 0; col < columns; col++) {
      for (let row = 0; row < rows; row++) {
        const slotIndex = row * columns + col;
        const slot = slotElements[slotIndex];
        const finalSymbol = results[col][row];
        const duration = 1000 + col * 200 + row * 100; // Staggered stop timing
        
        animationPromises.push(createSpinningAnimation(slot, finalSymbol, duration));
      }
    }

    // Wait for all animations to complete
    await Promise.all(animationPromises);
    
    // Check for wins
    setTimeout(() => {
      const { totalWin, winningLines } = checkWins(results);
      
      if (totalWin > 0) {
        balance += totalWin * currentBet;
        updateBalance();
        
        // Highlight winning slots
        winningLines.forEach(line => {
          line.forEach(pos => {
            const slotIndex = pos.row * columns + pos.col;
            if (totalWin >= currentBet * 10) {
              slotElements[slotIndex].classList.add('big-win');
            } else {
              slotElements[slotIndex].classList.add('win');
            }
          });
        });

        if (totalWin >= currentBet * 50) {
          showMessage(`–ú–ï–ì–ê –í–´–ò–ì–†–´–®! +${(totalWin * currentBet).toFixed(2)} ‚ÇΩ`);
          addBotMessage(`${username} –≤—ã–∏–≥—Ä–∞–ª ${(totalWin * currentBet).toFixed(2)} ‚ÇΩ!`);
        } else {
          showMessage(`–í—ã–∏–≥—Ä—ã—à: +${(totalWin * currentBet).toFixed(2)} ‚ÇΩ`);
        }

        // Check for jackpot
        if (Math.random() < 0.001) { // 0.1% chance
          balance += jackpot;
          showMessage(`–î–ñ–ï–ö–ü–û–¢! +${jackpot.toFixed(2)} ‚ÇΩ`);
          addBotMessage(`${username} —Å–æ—Ä–≤–∞–ª –î–ñ–ï–ö–ü–û–¢ ${jackpot.toFixed(2)} ‚ÇΩ!`);
          jackpot = 100000; // Reset jackpot
          updateJackpot();
        }

        // Trigger mini-game chance
        if (Math.random() < 0.05) { // 5% chance
          setTimeout(() => {
            startMiniGame();
          }, 2000);
        }
      }

      isSpinning = false;
      document.getElementById('spinButton').disabled = false;
      document.getElementById('autoSpinButton').disabled = false;
    }, 500);
  }

  function checkWins(results) {
    let totalWin = 0;
    let winningLines = [];

    // Check horizontal lines
    for (let row = 0; row < rows; row++) {
      const line = [];
      for (let col = 0; col < columns; col++) {
        line.push({row, col, symbol: results[col][row]});
      }
      const win = checkLine(line);
      if (win.multiplier > 0) {
        totalWin += win.multiplier;
        winningLines.push(win.positions);
      }
    }

    return { totalWin, winningLines };
  }

  function checkLine(line) {
    const symbols = line.map(pos => pos.symbol);
    const firstSymbol = symbols[0];
    
    // Count consecutive matching symbols from left
    let count = 1;
    for (let i = 1; i < symbols.length; i++) {
      if (symbols[i] === firstSymbol) {
        count++;
      } else {
        break;
      }
    }

    if (count >= 3 && payTable[firstSymbol]) {
      return {
        multiplier: payTable[firstSymbol][count] || 0,
        positions: line.slice(0, count)
      };
    }

    return { multiplier: 0, positions: [] };
  }

  // --- Mini Game ---
  function startMiniGame() {
    const overlay = document.getElementById('miniGameOverlay');
    const boxes = document.querySelectorAll('.box');
    const msg = document.getElementById('miniGameMsg');
    
    // Reset boxes
    boxes.forEach(box => {
      box.className = 'box';
      box.onclick = null;
    });

    const winningBox = Math.floor(Math.random() * 3) + 1;
    const winAmount = bet * (2 + Math.random() * 3); // 2-5x bet
    
    msg.textContent = `–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É! –í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: ${winAmount.toFixed(2)} ‚ÇΩ`;
    overlay.style.display = '';

    boxes.forEach(box => {
      box.onclick = function() {
        const boxNum = parseInt(this.dataset.box);
        boxes.forEach(b => b.onclick = null); // Disable all boxes
        
        if (boxNum === winningBox) {
          this.classList.add('win');
          balance += winAmount;
          updateBalance();
          msg.textContent = `–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${winAmount.toFixed(2)} ‚ÇΩ!`;
          addBotMessage(`${username} –≤—ã–∏–≥—Ä–∞–ª ${winAmount.toFixed(2)} ‚ÇΩ –≤ –º–∏–Ω–∏-–∏–≥—Ä–µ!`);
        } else {
          this.classList.add('lose');
          boxes[winningBox - 1].classList.add('win');
          msg.textContent = `–ù–µ –ø–æ–≤–µ–∑–ª–æ! –í—ã–∏–≥—Ä—ã—à–Ω–∞—è –∫–æ—Ä–æ–±–∫–∞ –±—ã–ª–∞ #${winningBox}`;
        }
      };
    });
  }

  // --- Auto Spin ---
  function startAutoSpin() {
    if (autoSpinActive) return;
    
    autoSpinActive = true;
    document.getElementById('autoSpinButton').style.display = 'none';
    document.getElementById('stopAutoSpinButton').style.display = '';
    
    autoSpinInterval = setInterval(() => {
      if (!isSpinning && (balance >= bet || freeSpinsManager.getFreeSpins() > 0)) {
        spin();
      } else if (!isSpinning) {
        stopAutoSpin();
        showMessage('–ê–≤—Ç–æ—Å–ø–∏–Ω –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
      }
    }, 3000);
  }

  function stopAutoSpin() {
    autoSpinActive = false;
    if (autoSpinInterval) {
      clearInterval(autoSpinInterval);
      autoSpinInterval = null;
    }
    document.getElementById('autoSpinButton').style.display = '';
    document.getElementById('stopAutoSpinButton').style.display = 'none';
  }

  // --- Event Listeners ---
  function initializeEventListeners() {
    // Spin button
    document.getElementById('spinButton').addEventListener('click', spin);
    
    // Auto spin buttons
    document.getElementById('autoSpinButton').addEventListener('click', startAutoSpin);
    document.getElementById('stopAutoSpinButton').addEventListener('click', stopAutoSpin);
    
    // Bet controls
    document.getElementById('betMinus').addEventListener('click', () => {
      if (bet > MIN_BET) {
        bet -= 10;
        document.getElementById('betAmount').textContent = bet;
        localStorage.setItem('slotBet', bet.toString());
      }
    });
    
    document.getElementById('betPlus').addEventListener('click', () => {
      if (bet < MAX_BET) {
        bet += 10;
        document.getElementById('betAmount').textContent = bet;
        localStorage.setItem('slotBet', bet.toString());
      }
    });

    // Replenish buttons
    document.querySelectorAll('.replenish-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const amount = parseInt(btn.dataset.amount);
        initiateYooMoneyPayment(amount);
      });
    });

    // Mini game close button
    document.getElementById('closeMiniGame').addEventListener('click', () => {
      document.getElementById('miniGameOverlay').style.display = 'none';
    });
  }

  // --- Initialize Game ---
  function initializeGame() {
    createSlotMachine();
    updateBalance();
    updateJackpot();
    freeSpinsManager.displayFreeSpins();
    initializeEventListeners();
    initializeWithdrawal();
    startBotMessages();
    
    // Update bet display
    document.getElementById('betAmount').textContent = bet;
    
    // Show welcome message
    setTimeout(() => {
      showMessage(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}! –£–¥–∞—á–Ω–æ–π –∏–≥—Ä—ã!`);
    }, 1000);
  }

  // Start the game when page loads
  window.addEventListener('load', initializeGame);
</script>

</body>
</html>






