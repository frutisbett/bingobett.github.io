<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>BingoBett - Слоты</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #1a1a1a);
            color: var(--tg-theme-text-color, #ffffff);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        h1 {
            font-size: 24px;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .info-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            gap: 10px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
            text-align: center;
        }
        
        .bet-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .bet-btn {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, white);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .bet-btn:active {
            transform: scale(0.9);
        }
        
        .slot-machine {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 4px;
            background: #222;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            width: 100%;
            aspect-ratio: 5/4;
        }
        
        .slot {
            background: #000;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 40px;
        }
        
        .slot.spinning {
            background: #111;
            border: 1px solid #0f0;
            animation: spin-glow 0.1s infinite alternate;
        }
        
        .slot.win {
            background: gold !important;
            color: black !important;
            animation: win-pulse 1s infinite alternate;
            box-shadow: 0 0 20px gold !important;
        }
        
        .slot.big-win {
            background: linear-gradient(45deg, gold, orange) !important;
            color: black !important;
            animation: big-win-pulse 0.5s infinite alternate;
        }
        
        @keyframes spin-glow {
            0% { box-shadow: inset 0 0 10px #0f0, 0 0 5px #0f0; }
            100% { box-shadow: inset 0 0 20px #ff0, 0 0 10px #ff0; }
        }
        
        @keyframes win-pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        
        @keyframes big-win-pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }
        
        .btn {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, white);
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn.secondary {
            background: #666;
        }
        
        .btn.danger {
            background: #dc3545;
        }
        
        .btn.success {
            background: #28a745;
        }
        
        .btn.warning {
            background: #ffc107;
            color: black;
        }
        
        .message {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            width: 100%;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: pre-line;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .jackpot {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: black;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            width: 100%;
        }
        
        .replenish-section {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            width: 100%;
        }
        
        .replenish-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .replenish-btn:active {
            transform: scale(0.95);
        }
        
        .bot-chat {
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            background: #111;
            border: 1px solid #0f0;
            border-radius: 8px;
            padding: 8px;
            font-family: monospace;
            font-size: 11px;
            color: #0f0;
        }
        
        .bot-message {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px dotted rgba(0, 255, 0, 0.3);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal {
            background: var(--tg-theme-secondary-bg-color, #2a2a2a);
            border-radius: 12px;
            padding: 20px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
        }
        
        .modal h3 {
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, white);
        }
        
        .modal input {
            width: 100%;
            max-width: 250px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #666;
            border-radius: 6px;
            background: var(--tg-theme-bg-color, #1a1a1a);
            color: var(--tg-theme-text-color, white);
            font-size: 16px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .mini-game {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .boxes {
            display: flex;
            gap: 10px;
        }
        
        .box {
            width: 60px;
            height: 60px;
            background: #333;
            border: 2px solid #0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .box:hover {
            background: #444;
            transform: scale(1.05);
        }
        
        .box.selected {
            background: #0088cc;
            border-color: #0088cc;
        }
        
        .box.win {
            background: #28a745;
            border-color: #28a745;
        }
        
        .box.lose {
            background: #dc3545;
            border-color: #dc3545;
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                max-width: 100%;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .info-bar {
                font-size: 12px;
                padding: 8px;
            }
            
            .slot {
                font-size: 16px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 12px;
            }
            
            .box {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎰 BingoBett</h1>
        
        <div class="info-bar">
            <div class="info-item">
                👤 <span id="username">Гость</span>
            </div>
            <div class="info-item">
                💰 <span id="balance">555</span> ₽
            </div>
            <div class="info-item">
                🎁 <span id="freeSpins">55</span> фриспинов
            </div>
            <div class="info-item bet-controls">
                Ставка: 
                <button class="bet-btn" id="betMinus">-</button>
                <span id="betAmount">10</span> ₽
                <button class="bet-btn" id="betPlus">+</button>
            </div>
        </div>
        
        <div class="jackpot">
            🏆 Джекпот: <span id="jackpot">2,200,453</span> ₽
        </div>
        
        <div class="replenish-section">
            <button class="replenish-btn" data-amount="50">+50₽</button>
            <button class="replenish-btn" data-amount="300">+300₽</button>
            <button class="replenish-btn" data-amount="500">+500₽</button>
            <button class="replenish-btn" data-amount="800">+800₽</button>
            <button class="btn warning" id="withdrawBtn">💳 Вывести</button>
        </div>
        
        <div class="slot-machine" id="slotMachine">
            <!-- Слоты будут созданы через JavaScript -->
        </div>
        
        <div class="controls">
            <button class="btn" id="spinBtn">🎰 Крутить</button>
            <button class="btn secondary" id="autoBtn">⚡ Автоспин</button>
            <button class="btn danger hidden" id="stopAutoBtn">⏹ Стоп</button>
            <button class="btn secondary" id="rulesBtn">📋 Правила</button>
        </div>
        
        <div class="message" id="message">
            Добро пожаловать в BingoBett! Удачной игры! 🍀
        </div>
        
        <div class="bot-chat" id="botChat">
            <div class="bot-message"><strong>🎯 Активные игроки:</strong></div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div class="modal-overlay hidden" id="usernameModal">
        <div class="modal">
            <h3>Добро пожаловать!</h3>
            <p>Введите ваше имя:</p>
            <input type="text" id="usernameInput" placeholder="Ваше имя" maxlength="20">
            <div class="modal-buttons">
                <button class="btn" id="usernameOk">Начать игру</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay hidden" id="withdrawModal">
        <div class="modal">
            <h3>💳 Вывод средств</h3>
            <p>Доступно к выводу: <span id="withdrawAmount">0</span> ₽</p>
            <input type="text" id="cardInput" placeholder="1234 5678 9012 3456" maxlength="19">
            <div id="withdrawError" style="color: #dc3545; margin: 10px 0;"></div>
            <div class="modal-buttons">
                <button class="btn success" id="confirmWithdraw">Подтвердить</button>
                <button class="btn secondary" id="cancelWithdraw">Отмена</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay hidden" id="miniGameModal">
        <div class="modal">
            <div class="mini-game">
                <h3>🎁 Бонусная игра!</h3>
                <p>Выберите коробку и получите приз!</p>
                <div class="boxes">
                    <div class="box" data-box="1">🎁</div>
                    <div class="box" data-box="2">🎁</div>
                    <div class="box" data-box="3">🎁</div>
                </div>
                <div id="miniGameResult">Выберите коробку!</div>
                <button class="btn secondary" id="closeMiniGame">Закрыть</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay hidden" id="rulesModal">
        <div class="modal" style="text-align: left; max-width: 500px;">
            <h3 style="text-align: center;">📋 Правила игры</h3>
            
            <h4>🎰 Основные правила:</h4>
            <ul>
                <li>Игровое поле: 5×4 (20 символов)</li>
                <li>Ставки: от 10 до 80 рублей</li>
                <li>4 выигрышные линии (горизонтальные)</li>
                <li>Минимум 3 символа подряд для выигрыша</li>
            </ul>
            
            <h4>💰 Выплаты:</h4>
            <div style="font-size: 12px; background: #333; padding: 8px; border-radius: 4px; margin: 8px 0;">
                🍒🍋🍊🍉🍇: ×5/×10/×20<br>
                🍓🍍: ×7/×14/×28<br>
                🥝🍌: ×10/×20/×40<br>
                🥥: ×12/×24/×48<br>
                🎁: ×15/×30/×60<br>
                💎: ×20/×40/×80<br>
                ⭐: ×25/×50/×100<br>
                🃏: ×30/×60/×120<br>
                👑: ×50/×100/×200<br>
                💰: ×100/×200/×500
            </div>
            
            <h4>🎁 Бонусы:</h4>
            <ul>
                <li>55 фриспинов для новых игроков</li>
                <li>Фриспины действуют 24 часа</li>
                <li>Случайные мини-игры</li>
                <li>Прогрессивный джекпот</li>
            </ul>
            
            <h4>💳 Вывод средств:</h4>
            <ul>
                <li>Минимум: 40,000 ₽ на балансе</li>
                <li>Выводится сумма свыше 40,000 ₽</li>
                <li>Обработка: до 24 часов</li>
            </ul>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn" id="closeRules">Понятно</button>
            </div>
        </div>
    </div>

    <script>
        console.log('BingoBett загружается...');
        
        // Глобальные переменные
        let tg = null;
        let isTelegram = false;
        
        // Инициализация Telegram WebApp
        try {
            if (typeof window !== 'undefined' && window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                isTelegram = true;
                console.log('Telegram WebApp инициализирован');
                
                // Применяем тему Telegram
                if (tg.themeParams) {
                    const root = document.documentElement;
                    if (tg.themeParams.bg_color) root.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color);
                    if (tg.themeParams.text_color) root.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color);
                    if (tg.themeParams.button_color) root.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color);
                    if (tg.themeParams.button_text_color) root.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color);
                }
            }
        } catch (e) {
            console.log('Telegram WebApp недоступен:', e);
        }
        
        // Haptic feedback
        function vibrate() {
            try {
                if (isTelegram && tg && tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
            } catch (e) {
                console.log('Haptic feedback недоступен');
            }
        }
        
        // Storage с fallback
        const storage = {
            get: function(key) {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    try {
                        return sessionStorage.getItem(key);
                    } catch (e2) {
                        return null;
                    }
                }
            },
            set: function(key, value) {
                try {
                    localStorage.setItem(key, value);
                } catch (e) {
                    try {
                        sessionStorage.setItem(key, value);
                    } catch (e2) {
                        console.log('Storage недоступен');
                    }
                }
            }
        };
        
        // Игровые символы и выплаты
        const SYMBOLS = ['🍒','🍋','🍊','🍉','🍇','🍓','🍍','🥝','🍌','🥥','🎁','💎','⭐','🃏','👑','💰'];
        const PAY_TABLE = {
            '🍒': [0,0,5,10,20], '🍋': [0,0,5,10,20], '🍊': [0,0,5,10,20], '🍉': [0,0,5,10,20], '🍇': [0,0,5,10,20],
            '🍓': [0,0,7,14,28], '🍍': [0,0,7,14,28],
            '🥝': [0,0,10,20,40], '🍌': [0,0,10,20,40],
            '🥥': [0,0,12,24,48],
            '🎁': [0,0,15,30,60],
            '💎': [0,0,20,40,80],
            '⭐': [0,0,25,50,100],
            '🃏': [0,0,30,60,120],
            '👑': [0,0,50,100,200],
            '💰': [0,0,100,200,500]
        };
        
        // Состояние игры
        let gameState = {
            balance: parseInt(storage.get('balance')) || 555,
            bet: parseInt(storage.get('bet')) || 10,
            jackpot: parseInt(storage.get('jackpot')) || 2200453,
            freeSpins: parseInt(storage.get('freeSpins')) || 55,
            username: storage.get('username') || '',
            spinning: false,
            autoSpin: false,
            autoInterval: null
        };
        
        console.log('Игровое состояние:', gameState);
        
        // Инициализация фриспинов
        if (!storage.get('registrationTime')) {
            storage.set('registrationTime', Date.now().toString());
            storage.set('freeSpins', '55');
        }
        
        // Проверка истечения фриспинов
        function checkFreeSpinsExpiry() {
            const regTime = parseInt(storage.get('registrationTime') || '0');
            const now = Date.now();
            const dayInMs = 24 * 60 * 60 * 1000;
            
            if (now - regTime > dayInMs) {
                gameState.freeSpins = 0;
                storage.set('freeSpins', '0');
            }
        }
        
        // DOM элементы
        function getElements() {
            return {
                username: document.getElementById('username'),
                balance: document.getElementById('balance'),
                freeSpins: document.getElementById('freeSpins'),
                betAmount: document.getElementById('betAmount'),
                jackpot: document.getElementById('jackpot'),
                message: document.getElementById('message'),
                slotMachine: document.getElementById('slotMachine'),
                botChat: document.getElementById('botChat'),
                
                betMinus: document.getElementById('betMinus'),
                betPlus: document.getElementById('betPlus'),
                spinBtn: document.getElementById('spinBtn'),
                autoBtn: document.getElementById('autoBtn'),
                stopAutoBtn: document.getElementById('stopAutoBtn'),
                withdrawBtn: document.getElementById('withdrawBtn'),
                rulesBtn: document.getElementById('rulesBtn'),
                
                usernameModal: document.getElementById('usernameModal'),
                withdrawModal: document.getElementById('withdrawModal'),
                miniGameModal: document.getElementById('miniGameModal'),
                rulesModal: document.getElementById('rulesModal')
            };
        }
        
        // Создание слотов
        function createSlots() {
            const slotMachine = document.getElementById('slotMachine');
            if (!slotMachine) {
                console.error('Слот-машина не найдена!');
                return;
            }
            
            slotMachine.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.textContent = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
                slotMachine.appendChild(slot);
            }
            console.log('Слоты созданы');
        }
        
        // Обновление UI
        function updateUI() {
            const elements = getElements();
            
            if (elements.username) elements.username.textContent = gameState.username || 'Гость';
            if (elements.balance) elements.balance.textContent = gameState.balance.toLocaleString();
            if (elements.freeSpins) elements.freeSpins.textContent = gameState.freeSpins;
            if (elements.betAmount) elements.betAmount.textContent = gameState.bet;
            if (elements.jackpot) elements.jackpot.textContent = gameState.jackpot.toLocaleString();
            
            // Сохранение
            storage.set('balance', gameState.balance.toString());
            storage.set('bet', gameState.bet.toString());
            storage.set('jackpot', gameState.jackpot.toString());
            storage.set('freeSpins', gameState.freeSpins.toString());
            storage.set('username', gameState.username);
        }
        
        // Показать сообщение
        function showMessage(text, duration = 4000) {
            const messageEl = document.getElementById('message');
            if (messageEl) {
                messageEl.textContent = text;
                setTimeout(() => {
                    messageEl.textContent = 'Удачной игры! 🍀';
                }, duration);
            }
        }
        
        // Добавить сообщение в чат
        function addBotMessage(text) {
            const botChat = document.getElementById('botChat');
            if (!botChat) return;
            
            const message = document.createElement('div');
            message.className = 'bot-message';
            message.textContent = `${new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'})} - ${text}`;
            botChat.appendChild(message);
            botChat.scrollTop = botChat.scrollHeight;
            
            while (botChat.children.length > 15) {
                botChat.removeChild(botChat.children[1]);
            }
        }
        
        // Проверка выигрышей
        function checkWins(grid) {
            let totalWin = 0;
            let winPositions = [];
            
            for (let row = 0; row < 4; row++) {
                const line = [];
                for (let col = 0; col < 5; col++) {
                    line.push(grid[row * 5 + col]);
                }
                
                const symbol = line[0];
                let count = 1;
                
                for (let i = 1; i < 5; i++) {
                    if (line[i] === symbol) {
                        count++;
                    } else {
                        break;
                    }
                }
                
                if (count >= 3 && PAY_TABLE[symbol]) {
                    const multiplier = PAY_TABLE[symbol][count];
                    totalWin += multiplier;
                    
                    for (let i = 0; i < count; i++) {
                        winPositions.push(row * 5 + i);
                    }
                }
            }
            
            return { totalWin, winPositions };
        }
        
        // Спин
        async function spin() {
            if (gameState.spinning) return;
            
            const canUseFreeSpins = gameState.freeSpins > 0;
            if (!canUseFreeSpins && gameState.balance < gameState.bet) {
                showMessage('❌ Недостаточно средств для ставки!');
                return;
            }
            
            gameState.spinning = true;
            const elements = getElements();
            if (elements.spinBtn) elements.spinBtn.disabled = true;
            if (elements.autoBtn) elements.autoBtn.disabled = true;
            
            vibrate();
            
            let usedFreeSpins = false;
            if (canUseFreeSpins && confirm(`Использовать фриспин? (Осталось: ${gameState.freeSpins})`)) {
                gameState.freeSpins--;
                usedFreeSpins = true;
                showMessage('🎁 Используется фриспин!');
            } else {
                gameState.balance -= gameState.bet;
            }
            
            gameState.jackpot += Math.floor(gameState.bet * 0.1);
            updateUI();
            
            const slotMachine = document.getElementById('slotMachine');
            const slots = slotMachine.children;
            
            for (let slot of slots) {
                slot.classList.add('spinning');
                slot.classList.remove('win', 'big-win');
            }
            
            const result = [];
            for (let i = 0; i < 20; i++) {
                result.push(SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)]);
            }
            
            for (let col = 0; col < 5; col++) {
                await new Promise(resolve => setTimeout(resolve, 200 + col * 100));
                
                for (let row = 0; row < 4; row++) {
                    const index = row * 5 + col;
                    const slot = slots[index];
                    if (slot) {
                        slot.classList.remove('spinning');
                        slot.textContent = result[index];
                    }
                }
                vibrate();
            }
            
            const { totalWin, winPositions } = checkWins(result);
            
            if (totalWin > 0) {
                const winAmount = totalWin * gameState.bet;
                gameState.balance += winAmount;
                
                winPositions.forEach(pos => {
                    if (slots[pos]) {
                        if (winAmount >= gameState.bet * 20) {
                            slots[pos].classList.add('big-win');
                        } else {
                            slots[pos].classList.add('win');
                        }
                    }
                });
                
                if (winAmount >= gameState.bet * 50) {
                    showMessage(`🎉 MEGA WIN! +${winAmount.toLocaleString()} ₽`, 6000);
                    addBotMessage(`${gameState.username} выиграл ${winAmount.toLocaleString()} ₽!`);
                } else {
                    showMessage(`💰 Выигрыш: +${winAmount.toLocaleString()} ₽`);
                }
                
                if (Math.random() < 0.0005) {
                    gameState.balance += gameState.jackpot;
                    showMessage(`🏆 ДЖЕКПОТ! +${gameState.jackpot.toLocaleString()} ₽`, 8000);
                    addBotMessage(`${gameState.username} сорвал ДЖЕКПОТ ${gameState.jackpot.toLocaleString()} ₽!`);
                    gameState.jackpot = 100000;
                }
                
                if (Math.random() < 0.03) {
                    setTimeout(() => startMiniGame(), 2000);
                }
            }
            
            updateUI();
            gameState.spinning = false;
            if (elements.spinBtn) elements.spinBtn.disabled = false;
            if (elements.autoBtn) elements.autoBtn.disabled = false;
        }
        
        // Автоспин
        function toggleAutoSpin() {
            const elements = getElements();
            
            if (gameState.autoSpin) {
                gameState.autoSpin = false;
                clearInterval(gameState.autoInterval);
                if (elements.autoBtn) elements.autoBtn.classList.remove('hidden');
                if (elements.stopAutoBtn) elements.stopAutoBtn.classList.add('hidden');
                showMessage('Автоспин остановлен');
            } else {
                gameState.autoSpin = true;
                if (elements.autoBtn) elements.autoBtn.classList.add('hidden');
                if (elements.stopAutoBtn) elements.stopAutoBtn.classList.remove('hidden');
                showMessage('Автоспин запущен');
                
                gameState.autoInterval = setInterval(() => {
                    if (!gameState.spinning && (gameState.balance >= gameState.bet || gameState.freeSpins > 0)) {
                        spin();
                    } else {
                        toggleAutoSpin();
                        showMessage('Автоспин остановлен: недостаточно средств');
                    }
                }, 3000);
            }
            vibrate();
        }
        
        // Мини-игра
        function startMiniGame() {
            const winningBox = Math.floor(Math.random() * 3) + 1;
            const prize = gameState.bet * (2 + Math.random() * 4);
            
            const miniGameModal = document.getElementById('miniGameModal');
            if (miniGameModal) {
                miniGameModal.classList.remove('hidden');
            }
            
            const boxes = document.querySelectorAll('.box');
            const result = document.getElementById('miniGameResult');
            
            if (result) {
                result.textContent = `Возможный выигрыш: ${Math.floor(prize).toLocaleString()} ₽`;
            }
            
            boxes.forEach((box, index) => {
                box.className = 'box';
                box.onclick = () => {
                    boxes.forEach(b => b.onclick = null);
                    
                    if (index + 1 === winningBox) {
                        box.classList.add('win');
                        gameState.balance += Math.floor(prize);
                        if (result) result.textContent = `🎉 Поздравляем! Вы выиграли ${Math.floor(prize).toLocaleString()} ₽!`;
                        addBotMessage(`${gameState.username} выиграл ${Math.floor(prize).toLocaleString()} ₽ в бонусной игре!`);
                    } else {
                        box.classList.add('lose');
                        boxes[winningBox - 1].classList.add('win');
                        if (result) result.textContent = `😔 Не повезло! Выигрышная коробка была №${winningBox}`;
                    }
                    updateUI();
                };
            });
        }
        
        // Вывод средств
        function initWithdraw() {
            const minBalance = 40000;
            if (gameState.balance <= minBalance) {
                showMessage(`❌ Недостаточно средств!\nМинимум для вывода: ${minBalance.toLocaleString()} ₽\nВаш баланс: ${gameState.balance.toLocaleString()} ₽`);
                return;
            }
            
            const withdrawAmount = gameState.balance - minBalance;
            const withdrawAmountEl = document.getElementById('withdrawAmount');
            if (withdrawAmountEl) {
                withdrawAmountEl.textContent = withdrawAmount.toLocaleString();
            }
            
            const withdrawModal = document.getElementById('withdrawModal');
            if (withdrawModal) {
                withdrawModal.classList.remove('hidden');
            }
        }
        
        function confirmWithdraw() {
            const cardInput = document.getElementById('cardInput');
            const cardNumber = cardInput ? cardInput.value.replace(/\s/g, '') : '';
            const errorEl = document.getElementById('withdrawError');
            
            if (!/^\d{16}$/.test(cardNumber)) {
                if (errorEl) errorEl.textContent = 'Введите корректный номер карты (16 цифр)';
                return;
            }
            
            const withdrawAmount = gameState.balance - 40000;
            gameState.balance = 40000;
            
            const withdrawModal = document.getElementById('withdrawModal');
            if (withdrawModal) {
                withdrawModal.classList.add('hidden');
            }
            
            showMessage(`✅ Заявка на вывод ${withdrawAmount.toLocaleString()} ₽ принята!\nКарта: ****-****-****-${cardNumber.slice(-4)}\nСрок обработки: до 24 часов`, 8000);
            addBotMessage(`${gameState.username} вывел ${withdrawAmount.toLocaleString()} ₽`);
            updateUI();
            vibrate();
        }
        
        // Пополнение баланса
        function replenish(amount) {
            setTimeout(() => {
                gameState.balance += amount;
                updateUI();
                showMessage(`✅ Баланс пополнен на ${amount} ₽`);
                addBotMessage(`${gameState.username} пополнил баланс на ${amount} ₽`);
            }, 1000);
            
            showMessage('💳 Обработка платежа...');
            vibrate();
        }
        
        // Случайные сообщения
        const BOT_MESSAGES = [
            'выиграл 450 ₽!', 'сорвал джекпот 15,000 ₽!', 'выиграла 820 ₽!',
            'получил бонус 1,200 ₽!', 'выиграла 650 ₽ в бонусной игре!',
            'сорвал куш 3,400 ₽!', 'выиграла 780 ₽!', 'получил 2,100 ₽!'
        ];
        
        const NAMES = ['Анна К.', 'Максим Р.', 'Елена В.', 'Игорь С.', 'Мария П.', 'Алексей К.', 'Ольга Н.', 'Дмитрий Л.'];
        
        function startBotMessages() {
            setInterval(() => {
                if (Math.random() < 0.4) {
                    const name = NAMES[Math.floor(Math.random() * NAMES.length)];
                    const message = BOT_MESSAGES[Math.floor(Math.random() * BOT_MESSAGES.length)];
                    addBotMessage(`${name} ${message}`);
                }
            }, 5000);
        }
        
        // Инициализация пользователя
        function initUser() {
            if (isTelegram && tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                gameState.username = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                updateUI();
                return;
            }
            
            if (!gameState.username) {
                const usernameModal = document.getElementById('usernameModal');
                if (usernameModal) {
                    usernameModal.classList.remove('hidden');
                    const usernameInput = document.getElementById('usernameInput');
                    if (usernameInput) {
                        setTimeout(() => usernameInput.focus(), 100);
                    }
                }
            }
        }
        
        // Обработчики событий
        function initEventListeners() {
            console.log('Инициализация обработчиков событий');
            
            // Ставки
            const betMinus = document.getElementById('betMinus');
            const betPlus = document.getElementById('betPlus');
            
            if (betMinus) {
                betMinus.onclick = () => {
                    if (gameState.bet > 10) {
                        gameState.bet -= 10;
                        updateUI();
                        vibrate();
                    }
                };
            }
            
            if (betPlus) {
                betPlus.onclick = () => {
                    if (gameState.bet < 80) {
                        gameState.bet += 10;
                        updateUI();
                        vibrate();
                    }
                };
            }
            
            // Игра
            const spinBtn = document.getElementById('spinBtn');
            const autoBtn = document.getElementById('autoBtn');
            const stopAutoBtn = document.getElementById('stopAutoBtn');
            
            if (spinBtn) spinBtn.onclick = spin;
            if (autoBtn) autoBtn.onclick = toggleAutoSpin;
            if (stopAutoBtn) stopAutoBtn.onclick = toggleAutoSpin;
            
            // Прочее
            const withdrawBtn = document.getElementById('withdrawBtn');
            const rulesBtn = document.getElementById('rulesBtn');
            
            if (withdrawBtn) {
                withdrawBtn.onclick = () => {
                    initWithdraw();
                    vibrate();
                };
            }
            
            if (rulesBtn) {
                rulesBtn.onclick = () => {
                    const rulesModal = document.getElementById('rulesModal');
                    if (rulesModal) rulesModal.classList.remove('hidden');
                    vibrate();
                };
            }
            
            // Пополнение
            document.querySelectorAll('.replenish-btn').forEach(btn => {
                btn.onclick = () => {
                    replenish(parseInt(btn.dataset.amount));
                };
            });
            
            // Модальные окна
            const usernameOk = document.getElementById('usernameOk');
            if (usernameOk) {
                usernameOk.onclick = () => {
                    const input = document.getElementById('usernameInput');
                    if (input && input.value.trim()) {
                        gameState.username = input.value.trim();
                        const usernameModal = document.getElementById('usernameModal');
                        if (usernameModal) usernameModal.classList.add('hidden');
                        updateUI();
                        vibrate();
                    }
                };
            }
            
            const confirmWithdraw = document.getElementById('confirmWithdraw');
            const cancelWithdraw = document.getElementById('cancelWithdraw');
            
            if (confirmWithdraw) confirmWithdraw.onclick = confirmWithdraw;
            if (cancelWithdraw) {
                cancelWithdraw.onclick = () => {
                    const withdrawModal = document.getElementById('withdrawModal');
                    if (withdrawModal) withdrawModal.classList.add('hidden');
                    const cardInput = document.getElementById('cardInput');
                    const withdrawError = document.getElementById('withdrawError');
                    if (cardInput) cardInput.value = '';
                    if (withdrawError) withdrawError.textContent = '';
                };
            }
            
            const closeMiniGame = document.getElementById('closeMiniGame');
            if (closeMiniGame) {
                closeMiniGame.onclick = () => {
                    const miniGameModal = document.getElementById('miniGameModal');
                    if (miniGameModal) miniGameModal.classList.add('hidden');
                };
            }
            
            const closeRules = document.getElementById('closeRules');
            if (closeRules) {
                closeRules.onclick = () => {
                    const rulesModal = document.getElementById('rulesModal');
                    if (rulesModal) rulesModal.classList.add('hidden');
                };
            }
            
            // Форматирование номера карты
            const cardInput = document.getElementById('cardInput');
            if (cardInput) {
                cardInput.oninput = (e) => {
                    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/g, '');
                    value = value.replace(/(.{4})/g, '$1 ').trim();
                    e.target.value = value;
                };
            }
            
            // Enter в полях ввода
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                usernameInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        const usernameOk = document.getElementById('usernameOk');
                        if (usernameOk) usernameOk.click();
                    }
                };
            }
            
            console.log('Обработчики событий инициализированы');
        }
        
        // Исправление функции confirmWithdraw
        window.confirmWithdraw = confirmWithdraw;
        
        // Инициализация игры
        function initGame() {
            console.log('Инициализация игры');
            
            checkFreeSpinsExpiry();
            createSlots();
            updateUI();
            initEventListeners();
            initUser();
            startBotMessages();
            
            setTimeout(() => {
                if (gameState.username) {
                    showMessage(`Добро пожаловать, ${gameState.username}! Удачной игры! 🍀`);
                }
            }, 1000);
            
            console.log('Игра инициализирована успешно');
        }
        
        // Запуск при загрузке страницы
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGame);
        } else {
            initGame();
        }
        
        console.log('BingoBett скрипт загружен');
    </script>
</body>
</html>
