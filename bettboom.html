<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BettBoom - Экстремальные слоты</title>
    <style>
        /* Ваши существующие стили */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .header {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            border-bottom: 2px solid gold;
        }
        .header h1 {
            margin: 0;
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            animation: glow 2s infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            to { text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.6); }
        }
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 20px;
        }
        .user-info {
            display: flex;
            justify-content: space-around;
            width: 90%;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .info-item {
            text-align: center;
        }
        .info-item span {
            color: var(--tg-theme-accent-text-color, #ffd700);
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        .slot-machine {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            width: 90%;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid gold;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        .slot {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .slot.win {
            animation: winAnimation 0.5s ease-in-out;
            background: rgba(255, 215, 0, 0.2);
        }
        @keyframes winAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            width: 90%;
            max-width: 500px;
        }
        button {
            padding: 12px 20px;
            font-size: 14px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .replenish-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }
        .auto-spin-btn {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }
        .stop-auto-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }
        .message {
            margin: 15px 0;
            min-height: 2em;
            text-align: center;
            color: #ffeb3b;
            font-size: 14px;
            max-width: 90vw;
            word-wrap: break-word;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        #botChat {
            width: 90%;
            max-width: 400px;
            height: 80px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            overflow-y: auto;
            font-size: 11px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .bot-message {
            margin-bottom: 3px;
            color: #bbb;
        }
        .modal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: #333;
            padding: 25px;
            border-radius: 15px;
            color: white;
            min-width: 300px;
            max-width: 90vw;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal input {
            margin: 15px 0;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #555;
            width: 220px;
            background: #222;
            color: white;
        }
        .modal button {
            padding: 10px 20px;
            font-size: 14px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 6px;
        }
        .modal button.cancel {
            background: #f44336;
        }
        /* Улучшенное модальное окно пополнения */
        #inGameReplenishModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        /* Мини-игра "Дождь монет" */
        #coinRainOverlay {
            background: rgba(0, 0, 0, 0.95);
        }
        #coinRainCanvas {
            width: 100%;
            height: 100%;
            cursor: pointer;
            touch-action: manipulation;
        }
        #coinRainUI {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 18px;
            color: var(--tg-theme-accent-text-color, #ffd700);
            z-index: 1001;
            pointer-events: none;
        }
        #coinRainTitle {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            animation: coinRainTitlePulse 1s infinite alternate;
        }
        @keyframes coinRainTitlePulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        #coinRainResult {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: var(--tg-theme-accent-text-color, #ffd700);
            z-index: 1002;
        }
        #coinRainResultText {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        #coinRainClose {
            padding: 12px 24px;
            font-size: 16px;
            background: var(--tg-theme-button-color, #4caf50);
            color: var(--tg-theme-button-text-color, white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .browser-notice {
            background: linear-gradient(135deg, #2196f3, #1565c0);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 12px;
        }
        .win-animation {
            animation: winPulse 0.5s ease-in-out;
        }
        @keyframes winPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .jackpot-info {
            color: gold;
            animation: jackpotGlow 2s ease-in-out infinite alternate;
        }
        @keyframes jackpotGlow {
            0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
        }
        .freespin-info {
            color: #4caf50;
        }
        /* Специальные стили для улучшения видимости */
        #usernameDisplay {
            color: var(--tg-theme-accent-text-color, #ffd700) !important;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        #balanceDisplay {
            color: var(--tg-theme-accent-text-color, #ffd700) !important;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        #betDisplay {
            color: var(--tg-theme-accent-text-color, #ffd700) !important;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        #betAmountDisplay {
            color: var(--tg-theme-accent-text-color, #ffd700) !important;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        .loading {
            opacity: 0;
            animation: fadeIn 0.8s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 360px) {
            .slot {
                font-size: 5vw;
            }
            .user-info {
                font-size: 11px;
            }
            button {
                font-size: 11px;
                padding: 10px 12px;
            }
        }
        /* Стили для мини-игр */
        .mini-game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .mini-game-content {
            background: #333;
            padding: 25px;
            border-radius: 15px;
            color: white;
            text-align: center;
            border: 2px solid gold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .boxes {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        .box {
            font-size: 3rem;
            cursor: pointer;
            padding: 20px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .box:hover {
            transform: scale(1.1);
            background: rgba(255, 215, 0, 0.2);
        }
        .mini-game-msg {
            font-size: 1.2rem;
            margin: 20px 0;
        }
        .win-box {
            animation: boxWin 0.5s ease-in-out;
        }
        @keyframes boxWin {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .rules-content {
            background: #333;
            padding: 25px;
            border-radius: 15px;
            color: white;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .rules-content h3 {
            color: gold;
            text-align: center;
            margin-top: 0;
        }
        .rules-content p {
            line-height: 1.5;
        }
    </style>
</head>
<body class="loading">
    <div class="browser-notice" style="display: none;">🖥️ <strong>Локальная версия для тестирования</strong> • Игра полностью работает в браузере</div>
    <div class="header">
        <h1>💥 BettBoom</h1>
    </div>
    <div class="game-container">
        <div class="user-info">
            <div class="info-item">Игрок: <span id="usernameDisplay">-</span></div>
            <div class="info-item">Баланс: <span id="balanceDisplay">0.00</span> ₽</div>
            <div class="info-item">Ставка: <span id="betAmountDisplay">100</span> ₽</div>
            <div class="info-item">Фриспины: <span id="freeSpinsDisplay" class="freespin-info">0</span></div>
            <div class="info-item">Джекпот: <span id="jackpotDisplay" class="jackpot-info">0.00</span> ₽</div>
        </div>
        <div class="slot-machine" id="slotMachine">
            <!-- Слоты будут добавлены здесь -->
        </div>
        <div class="message" id="message">💥 Игра полностью исправлена и готова! Нажмите "Крутить"</div>
        <div id="botChat">
            <b>🔥 Активные игроки:</b><br>
        </div>
        <div class="controls">
            <button id="spinButton">🎰 Крутить</button>
            <button id="autoSpinButton" class="auto-spin-btn">🔄 Авто</button>
            <button id="stopAutoButton" class="stop-auto-btn" style="display: none;">⏹️ Стоп</button>
            <button id="rulesButton">📖 Правила</button>
            <button id="withdrawBtn">💸 Вывод</button>
            <button class="replenish-btn" data-amount="500">💳 500 ₽</button>
            <button class="replenish-btn" data-amount="800">💳 800 ₽</button>
            <button class="replenish-btn" data-amount="1000">💳 1000 ₽</button>
            <button class="replenish-btn" data-amount="10000">💳 10000 ₽</button>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button id="decreaseBet">-</button>
            <button id="increaseBet">+</button>
        </div>
    </div>

    <!-- Мини-игра -->
    <div class="mini-game-overlay" id="miniGameOverlay">
        <div class="mini-game-content">
            <h3>🎁 Мини-игра: выберите коробку!</h3>
            <div class="boxes">
                <div class="box" data-box="1">🎁</div>
                <div class="box" data-box="2">🎁</div>
                <div class="box" data-box="3">🎁</div>
            </div>
            <div class="mini-game-msg" id="miniGameMsg">Выберите одну из коробок - в одной из них приз!</div>
        </div>
    </div>

    <!-- Мини-игра "Дождь монет" -->
    <div id="coinRainOverlay" class="mini-game-overlay" style="display: none;">
        <div id="coinRainUI">
            <div id="coinRainTitle">💰 Дождь монет 💰</div>
            <div>Поймано: <span id="coinsCaught">0</span> ₽</div>
            <div>Время: <span id="timeLeft">4</span> сек</div>
        </div>
        <canvas id="coinRainCanvas"></canvas>
        <div id="coinRainResult" style="display:none;">
            <div id="coinRainResultText"></div>
            <button id="coinRainClose">Забрать выигрыш</button>
        </div>
    </div>

    <!-- Модальное окно ввода имени -->
    <div id="usernameModal" class="modal-bg">
        <div class="modal">
            <h3>💥 Добро пожаловать в BettBoom!</h3>
            <div>Введите ваше имя для игры:</div>
            <input id="usernameInput" maxlength="20" autocomplete="off" placeholder="Имя игрока">
            <button id="usernameOkBtn">✅ Начать игру</button>
        </div>
    </div>

    <!-- Модальное окно вывода -->
    <div id="withdrawModal" class="modal-bg" style="display:none;">
        <div class="modal">
            <h3>💸 Вывод средств</h3>
            <div id="withdrawWarning" style="background: rgba(255, 0, 0, 0.1); border: 1px solid red; border-radius: 5px; padding: 10px; margin: 10px 0; display: none;">
                <div style="font-weight: bold; color: red; margin-bottom: 5px;">🚫 ВЫВОД НЕДОСТУПЕН</div>
                <div id="withdrawWarningText"></div>
            </div>
            <div id="withdrawForm">
                <div style="margin: 10px 0;">Номер банковской карты (16 цифр):</div>
                <input id="cardNumberInput" maxlength="19" placeholder="1234 5678 9012 3456">
                <div style="margin: 10px 0;">Ваш баланс: <span id="currentBalanceDisplay">0.00</span> ₽<br>
                Максимум для вывода: <span id="withdrawAmount">0.00</span> ₽</div>
                <div id="withdrawError"></div>
                <button id="confirmWithdrawBtn">📤 Подтвердить вывод</button>
            </div>
            <button class="cancel" id="cancelWithdrawBtn">❌ Отмена</button>
        </div>
    </div>

    <!-- Модальное окно правил -->
    <div id="rulesModal" class="rules-modal">
        <div class="rules-content">
            <h3>📖 Правила игры</h3>
            <p>• <b>Цель игры:</b> Выигрывать как можно больше денег в слотах</p>
            <p>• <b>Ставки:</b> Минимальная ставка 100 ₽, максимальная 10000 ₽</p>
            <p>• <b>Выигрыши:</b> Выигрыши зависят от комбинации символов</p>
            <p>• <b>Фриспины:</b> Получите 55 бесплатных спинов каждые 24 часа</p>
            <p>• <b>Джекпот:</b> Случайные крупные выигрыши</p>
            <p>• <b>Мини-игры:</b> Случайные бонусные игры</p>
            <p>• <b>"Выбери коробку":</b> Выберите одну из 3 коробок для получения бонуса</p>
            <p>• <b>"Дождь монет":</b> Ловите падающие монеты за 4 секунды! Тапайте по экрану</p>
            <p>• <b>Шанс запуска:</b> 35% при выигрыше + 15% без выигрыша (всего ~50%)</p>
            <p>• <b>Частота:</b> В среднем каждые 2-3 спина появляется мини-игра</p>
            <p>• Бонус от 60% до 240% от ставки в зависимости от успеха</p><br>
            <p><b>🏆 Выигрышные линии:</b></p>
            <p>• 4 горизонтальные линии (ряды)</p>
            <p>• 2 диагональные линии (↘ и ↙)</p>
            <div style="text-align: center; margin-top: 20px;">
                <button id="closeRulesBtn">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Улучшенное модальное окно пополнения -->
    <div id="inGameReplenishModal" class="modal-bg">
        <div class="modal">
            <h3>💳 Пополнение баланса</h3>
            <p>Сумма: <strong id="modalAmount">0</strong> ₽</p>
            <div style="margin: 15px 0; padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px; border: 1px solid gold;">
                <p style="font-size: 12px; margin: 0;">
                    <strong>⚠️ Важно:</strong><br>
                    Платеж будет обработан через Яндекс.Кассу<br>
                    Вы останетесь в игре после оплаты
                </p>
            </div>
            <div style="margin: 15px 0;">
                <button id="processPaymentBtn" style="width: 100%; padding: 12px; background: linear-gradient(45deg, #4CAF50, #45a049); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                    ✅ Оплатить <span id="modalAmountBtn">0</span> ₽
                </button>
            </div>
            <div style="text-align: center;">
                <button id="cancelPaymentBtn" style="padding: 8px 15px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    ❌ Отмена
                </button>
            </div>
        </div>
    </div>

    <script>
        // Игровые переменные
        const reels = [
            ["🍒","🍓","🍍","🥝","🍌","🥥","🎁","💎","🍒","🍋","🍊","🍉","🍇","🍓","🍍","🥝","⭐","🃏"],
            ["🍒","🍓","🍍","🥝","🍌","🥥","🎁","💎","🍒","🍋","🍊","🍉","🍇","🍓","🍍","🥝","⭐","🃏"],
            ["🍒","🍓","🍍","🥝","🍌","🥥","🎁","💎","🍒","🍋","🍊","🍉","🍇","🍓","🍍","🥝","⭐","🃏"],
            ["🍒","🍓","🍍","🥝","🍌","🥥","🎁","💎","🍒","🍋","🍊","🍉","🍇","🍓","🍍","🥝","⭐","🃏"],
            ["🍒","🍓","🍍","🥝","🍌","🥥","🎁","💎","🍒","🍋","🍊","🍉","🍇","🍓","🍍","🥝","⭐","🃏"]
        ];
        const payTable = {
            "🍒": {3:8, 4:15, 5:30},
            "🍋": {3:8, 4:15, 5:30},
            "🍊": {3:8, 4:15, 5:30},
            "🍉": {3:8, 4:15, 5:30},
            "🍇": {3:8, 4:15, 5:30},
            "🍓": {3:12, 4:20, 5:40},
            "🍍": {3:12, 4:20, 5:40},
            "🥝": {3:15, 4:30, 5:60},
            "🍌": {3:15, 4:30, 5:60},
            "🥥": {3:20, 4:40, 5:80},
            "🎁": {3:25, 4:50, 5:100},
            "💎": {3:30, 4:60, 5:120},
            "⭐": {3:40, 4:80, 5:160},
            "🃏": {3:50, 4:100, 5:200},
            "👑": {3:80, 4:160, 5:320},
            "💰": {3:150, 4:300, 5:800}
        };

        // Состояние игры
        let balance = parseFloat(localStorage.getItem('local_slotBalance')) || 5000;
        let betAmount = 100;
        let isSpinning = false;
        let isAutoSpinning = false;
        let autoSpinInterval;
        let username = localStorage.getItem('username') || '';
        let tgUser = null;
        let isTelegramApp = false;
        let jackpot = 0;
        let lastWin = 0;
        let freeSpinsManager = new FreeSpinsManager();

        // Инициализация игры
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация Telegram WebApp
            initTelegramWebApp();
            
            // Создаем слоты
            createSlots();
            
            // Устанавливаем обработчики событий
            setupEventListeners();
            
            // Инициализация модальных окон
            initializeModals();
            
            // Запуск бот-чата
            startBotChat();
            
            // Обновляем UI
            updateUI();
            
            // Проверяем URL параметры для возврата после оплаты
            checkPaymentReturn();
        });

        // Улучшенная функция пополнения средств
        function setupReplenishButtons() {
            const replenishButtons = document.querySelectorAll('.replenish-btn');
            replenishButtons.forEach(btn => {
                btn.onclick = () => {
                    const amount = parseInt(btn.getAttribute('data-amount'));
                    console.log(`🛒 Пополнение на ${amount} ₽`);
                    
                    // Показываем модальное окно пополнения внутри игры
                    showInGameReplenishModal(amount);
                };
            });
        }

        function showInGameReplenishModal(amount) {
            // Устанавливаем сумму в модальном окне
            document.getElementById('modalAmount').textContent = amount;
            document.getElementById('modalAmountBtn').textContent = amount;
            
            // Создаем модальное окно внутри игры
            const modal = document.getElementById('inGameReplenishModal');
            modal.style.display = 'flex';
            
            // Обработчики событий
            document.getElementById('processPaymentBtn').onclick = () => {
                processPayment(amount);
                modal.style.display = 'none';
            };
            
            document.getElementById('cancelPaymentBtn').onclick = () => {
                modal.style.display = 'none';
            };
        }

        function processPayment(amount) {
            // Показываем сообщение о процессе
            showMessage(`💳 Обработка платежа ${amount}₽...`);
            
            // Генерируем уникальный ID платежа
            const paymentId = `bingobett_${Date.now()}_${Math.random().toString(36).substring(7)}`;
            
            // Сохраняем информацию о платеже
            const paymentInfo = {
                id: paymentId,
                amount: amount,
                timestamp: Date.now(),
                status: 'pending'
            };
            localStorage.setItem('pendingPayment', JSON.stringify(paymentInfo));
            
            // Формируем URL для YooMoney с возвратом на игру
            const successURL = `${window.location.origin}${window.location.pathname}?payment=success&amount=${amount}&id=${paymentId}`;
            
            // Создаем URL для оплаты
            const yoomoneyUrl = `https://yoomoney.ru/quickpay/confirm.xml?receiver=4100118182998706&quickpay-form=shop&targets=BingoBett%20пополнение%20(${paymentId})&paymentType=AC&sum=${amount}&label=${paymentId}&successURL=${encodeURIComponent(successURL)}`;
            
            // Открываем платеж в новой вкладке (или в том же окне, если нужно)
            window.open(yoomoneyUrl, '_blank');
            
            // Показываем инструкции пользователю
            showMessage(`💳 Открывается платеж на ${amount}₽...
⚡ Пожалуйста, завершите оплату в новой вкладке`);
            
            // После оплаты проверяем через 5 секунд
            setTimeout(() => {
                checkPaymentStatus(paymentId, amount);
            }, 5000);
        }

        function checkPaymentStatus(paymentId, amount) {
            // Проверяем, есть ли успешный платеж в localStorage или URL
            const pendingPayment = JSON.parse(localStorage.getItem('pendingPayment') || '{}');
            if (pendingPayment.id === paymentId && pendingPayment.status === 'pending') {
                // Платеж не обработан - предполагаем, что пользователь отменил или не завершил
                showMessage(`❌ Платеж не был завершен. Попробуйте снова.`);
            }
        }

        function initTelegramWebApp() {
            // Проверяем наличие Telegram WebApp
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
                console.log('✅ Telegram WebApp обнаружен');
                isTelegramApp = true;
                const tg = window.Telegram.WebApp;
                tg.expand();
                tg.setHeaderColor('#1a1a2e');
                tg.setBackgroundColor('#1a1a2e');
                
                tgUser = tg.initDataUnsafe?.user;
                if (tgUser) {
                    console.log('👤 Пользователь Telegram:', tgUser.first_name, tgUser.id);
                    getTelegramUsername();
                } else {
                    console.log('⚠️ Данные пользователя недоступны');
                }
                
                // MainButton
                if (tg.MainButton) {
                    tg.MainButton.setText('🎰 Крутить');
                    tg.MainButton.show();
                    tg.MainButton.onClick(() => {
                        if (!isSpinning && spinButton) {
                            startSpin();
                        }
                    });
                    console.log('✅ MainButton настроена');
                }
                
                // Haptic feedback
                if (tg.HapticFeedback && typeof tg.HapticFeedback.impactOccurred === 'function') {
                    tg.HapticFeedback.impactOccurred('medium');
                    console.log('✅ Haptic feedback работает');
                }
            } else {
                console.log('⚠️ Telegram WebApp не обнаружен');
                isTelegramApp = false;
                // Включаем локальный режим для тестирования
                document.querySelector('.browser-notice').style.display = 'block';
            }
        }

        function getTelegramUsername() {
            if (tgUser && tgUser.username) {
                username = tgUser.username;
                localStorage.setItem('username', username);
                updateUI();
            }
        }

        function createSlots() {
            const slotMachine = document.getElementById('slotMachine');
            slotMachine.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const slot = document.createElement('div');
                slot.classList.add('slot');
                slot.textContent = "🍒";
                slotMachine.appendChild(slot);
            }
        }

        function updateUI() {
            document.getElementById('usernameDisplay').textContent = username || 'Гость';
            document.getElementById('balanceDisplay').textContent = balance.toFixed(2);
            document.getElementById('betAmountDisplay').textContent = betAmount;
            document.getElementById('freeSpinsDisplay').textContent = freeSpinsManager.getFreeSpins();
            document.getElementById('jackpotDisplay').textContent = jackpot.toFixed(2);
            document.getElementById('currentBalanceDisplay').textContent = balance.toFixed(2);
            document.getElementById('withdrawAmount').textContent = (balance - 40000).toFixed(2);
        }

        function showMessage(message) {
            const messageElement = document.getElementById('message');
            messageElement.innerHTML = message;
            setTimeout(() => {
                messageElement.innerHTML = '';
            }, 5000);
        }

        function addBotMessage(message) {
            const chat = document.getElementById('botChat');
            const messageElement = document.createElement('div');
            messageElement.className = 'bot-message';
            messageElement.textContent = message;
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }

        function startBotChat() {
            const botNames = ["Алексей", "Мария", "Дмитрий", "Анна", "Сергей", "Елена", "Максим", "Ольга", "Иван", "Татьяна"];
            const botMessages = [
                "Поздравляем с победой!",
                "Выиграл 1000 ₽!",
                "Поздравляем с джекпотом!",
                "Попробуйте еще раз!",
                "Выигрыш на 500 ₽!",
                "Счастливый игрок!",
                "Играйте усерднее!",
                "Удача на вашей стороне!",
                "Спасибо за игру!",
                "Вы молодец!"
            ];

            setInterval(() => {
                if (Math.random() > 0.7) {
                    const name = botNames[Math.floor(Math.random() * botNames.length)];
                    const message = botMessages[Math.floor(Math.random() * botMessages.length)];
                    addBotMessage(`${name}: ${message}`);
                }
            }, 7000);
        }

        function setupEventListeners() {
            const spinButton = document.getElementById('spinButton');
            const autoSpinButton = document.getElementById('autoSpinButton');
            const stopAutoButton = document.getElementById('stopAutoButton');
            const increaseBetButton = document.getElementById('increaseBet');
            const decreaseBetButton = document.getElementById('decreaseBet');
            const rulesButton = document.getElementById('rulesButton');
            const withdrawBtn = document.getElementById('withdrawBtn');
            const closeRulesBtn = document.getElementById('closeRulesBtn');
            const confirmWithdrawBtn = document.getElementById('confirmWithdrawBtn');
            const cancelWithdrawBtn = document.getElementById('cancelWithdrawBtn');
            const cardInput = document.getElementById('cardNumberInput');
            
            // Кнопки пополнения через дилера (улучшенные)
            setupReplenishButtons();
            
            // Кнопка вращения
            if (spinButton) {
                spinButton.onclick = () => {
                    if (!isSpinning && !isAutoSpinning) {
                        startSpin();
                    }
                };
            }
            
            // Авто-вращение
            if (autoSpinButton) {
                autoSpinButton.onclick = () => {
                    if (!isAutoSpinning) {
                        isAutoSpinning = true;
                        autoSpinButton.style.display = 'none';
                        stopAutoButton.style.display = 'inline-block';
                        autoSpinInterval = setInterval(() => {
                            if (!isSpinning) {
                                startSpin();
                            }
                        }, 1500);
                    }
                };
            }
            
            // Остановка авто-вращения
            if (stopAutoButton) {
                stopAutoButton.onclick = () => {
                    isAutoSpinning = false;
                    clearInterval(autoSpinInterval);
                    autoSpinButton.style.display = 'inline-block';
                    stopAutoButton.style.display = 'none';
                };
            }
            
            // Увеличение ставки
            if (increaseBetButton) {
                increaseBetButton.onclick = () => {
                    if (betAmount < 10000) {
                        betAmount += 100;
                        updateUI();
                    }
                };
            }
            
            // Уменьшение ставки
            if (decreaseBetButton) {
                decreaseBetButton.onclick = () => {
                    if (betAmount > 100) {
                        betAmount -= 100;
                        updateUI();
                    }
                };
            }
            
            // Правила игры
            if (rulesButton) {
                rulesButton.onclick = () => {
                    document.getElementById('rulesModal').style.display = 'flex';
                };
            }
            
            // Закрытие правил
            if (closeRulesBtn) {
                closeRulesBtn.onclick = () => {
                    document.getElementById('rulesModal').style.display = 'none';
                };
            }
            
            // Вывод средств
            if (withdrawBtn) {
                withdrawBtn.onclick = () => {
                    document.getElementById('withdrawModal').style.display = 'flex';
                };
            }
            
            // Форматирование номера карты
            if (cardInput) {
                cardInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    let formattedValue = '';
                    for (let i = 0; i < value.length; i++) {
                        if (i > 0 && i % 4 === 0) {
                            formattedValue += ' ';
                        }
                        formattedValue += value[i];
                    }
                    e.target.value = formattedValue;
                });
            }
            
            // Подтверждение вывода
            if (confirmWithdrawBtn) {
                confirmWithdrawBtn.onclick = () => {
                    const cardNumber = document.getElementById('cardNumberInput').value.replace(/\s/g, '');
                    const withdrawForm = document.getElementById('withdrawForm');
                    const withdrawWarning = document.getElementById('withdrawWarning');
                    const withdrawError = document.getElementById('withdrawError');
                    
                    // Очищаем предыдущие ошибки
                    withdrawError.textContent = '';
                    
                    if (balance <= 40000) {
                        // Показываем предупреждение о недостаточном балансе
                        const needed = 40001 - balance;
                        withdrawWarning.style.display = 'block';
                        withdrawForm.style.display = 'none';
                        let warningMessage = `<div style="margin-bottom: 10px;"><strong>Ваш баланс: ${balance.toFixed(2)} ₽</strong><br><strong>Требуется: 40,001.00 ₽</strong><br><strong style="color: red;">Не хватает: ${needed.toFixed(2)} ₽</strong></div>`;
                        
                        if (balance < 1000) {
                            warningMessage += `<div style="color: #ff6b6b;">💡 <strong>Совет:</strong> Попробуйте сделать несколько ставок или пополните баланс кнопками выше.</div>`;
                        } else if (balance < 10000) {
                            warningMessage += `<div style="color: #ff9500;">🎰 <strong>Совет:</strong> Продолжайте играть! Вам осталось выиграть еще ${needed.toFixed(2)} ₽.</div>`;
                        } else if (balance < 30000) {
                            warningMessage += `<div style="color: #ff9500;">🚀 <strong>Почти готово!</strong> Осталось совсем немного - ${needed.toFixed(2)} ₽.</div>`;
                        } else {
                            warningMessage += `<div style="color: #ff9500;">🎯 <strong>Совсем близко!</strong> Еще ${needed.toFixed(2)} ₽ и вывод будет доступен!</div>`;
                        }
                        document.getElementById('withdrawWarningText').innerHTML = warningMessage;
                        showMessage(`❌ Вывод недоступен! Минимальный баланс: 40,001 ₽. Не хватает: ${needed.toFixed(2)} ₽`);
                    } else {
                        // Баланс достаточен для вывода
                        withdrawWarning.style.display = 'none';
                        withdrawForm.style.display = 'block';
                        const withdrawableAmount = balance - 40000;
                        document.getElementById('withdrawAmount').textContent = withdrawableAmount.toFixed(2);
                        cardInput.value = '';
                    }
                };
            }
            
            // Отмена вывода
            if (cancelWithdrawBtn) {
                cancelWithdrawBtn.onclick = () => {
                    document.getElementById('withdrawModal').style.display = 'none';
                };
            }
            
            // Закрытие модальных окон при клике вне области
            [document.getElementById('withdrawModal'), document.getElementById('rulesModal')].forEach(modal => {
                if (modal) {
                    modal.onclick = function(event) {
                        if (event.target === modal) {
                            modal.style.display = 'none';
                        }
                    };
                }
            });
        }

        function initializeModals() {
            // Модальное окно имени
            const modal = document.getElementById('usernameModal');
            const input = document.getElementById('usernameInput');
            const okBtn = document.getElementById('usernameOkBtn');
            
            if (!username) {
                modal.style.display = 'flex';
            }
            
            if (okBtn) {
                okBtn.onclick = function() {
                    const name = input.value.trim();
                    if (name && name.length <= 20) {
                        username = name;
                        localStorage.setItem('username', username);
                        updateUI();
                        modal.style.display = 'none';
                        showMessage(`Добро пожаловать, ${name}! Удачи в игре!`);
                    } else {
                        alert('Введите корректное имя (до 20 символов)');
                    }
                };
            }
        }

        function startSpin() {
            if (isSpinning) return;
            console.log('🎰 Начинаем вращение...');
            
            // Проверяем, достаточно ли средств для ставки
            const freeSpins = freeSpinsManager.getFreeSpins();
            let isUsingFreeSpin = false;
            
            if (freeSpins > 0) {
                isUsingFreeSpin = true;
                freeSpinsManager.useFreeSpins(1);
                showMessage('🎁 Используется фриспин!');
            } else if (balance >= betAmount) {
                balance -= betAmount;
                updateUI();
            } else {
                showMessage('❌ Недостаточно средств для ставки!');
                return;
            }
            
            isSpinning = true;
            const spinButton = document.getElementById('spinButton');
            if (spinButton) {
                spinButton.disabled = true;
            }
            
            const slotElements = document.querySelectorAll('.slot');
            const slotMachine = document.getElementById('slotMachine');
            let spinCount = 0;
            const spinDuration = 2000; // 2 секунды
            const spinInterval = 50; // 50 мс между обновлениями
            
            // Функция для случайного символа
            function getRandomSymbol() {
                const symbols = ["🍒","🍓","🍍","🥝","🍌","🥥","🎁","💎","🍋","🍊","🍉","🍇","⭐","🃏","👑","💰"];
                return symbols[Math.floor(Math.random() * symbols.length)];
            }
            
            // Функция для анимации вращения
            function animateSpin() {
                if (spinCount >= spinDuration / spinInterval) {
                    finishSpin();
                    return;
                }
                
                slotElements.forEach((slot, index) => {
                    // Используем случайные символы для анимации
                    slot.textContent = getRandomSymbol();
                });
                
                spinCount++;
                setTimeout(animateSpin, spinInterval);
            }
            
            // Запускаем анимацию
            animateSpin();
            
            // Функция завершения вращения
            function finishSpin() {
                // Получаем финальные символы
                const results = [];
                for (let i = 0; i < 5; i++) {
                    const reel = reels[i];
                    const result = reel[Math.floor(Math.random() * reel.length)];
                    results.push(result);
                }
                
                // Устанавливаем финальные символы
                slotElements.forEach((slot, index) => {
                    slot.textContent = results[index % 5];
                });
                
                // Проверяем выигрыш
                checkWin(results);
                
                isSpinning = false;
                if (spinButton) {
                    spinButton.disabled = false;
                }
                
                // Обновляем UI
                updateUI();
            }
        }

        function checkWin(results) {
            // Проверка выигрышных комбинаций
            let totalWin = 0;
            let winLines = [];
            
            // Проверяем горизонтальные линии
            for (let row = 0; row < 4; row++) {
                const lineSymbols = [];
                for (let col = 0; col < 5; col++) {
                    lineSymbols.push(results[col]);
                }
                
                // Проверяем на выигрыш
                const symbolCounts = {};
                lineSymbols.forEach(symbol => {
                    symbolCounts[symbol] = (symbolCounts[symbol] || 0) + 1;
                });
                
                for (const symbol in symbolCounts) {
                    const count = symbolCounts[symbol];
                    if (count >= 3 && payTable[symbol] && payTable[symbol][count]) {
                        const winAmount = payTable[symbol][count] * betAmount;
                        totalWin += winAmount;
                        winLines.push({
                            line: `Линия ${row + 1}`,
                            symbol: symbol,
                            count: count,
                            win: winAmount
                        });
                    }
                }
            }
            
            // Проверяем диагональные линии
            const diagonal1 = [results[0], results[1], results[2], results[3], results[4]];
            const diagonal2 = [results[4], results[3], results[2], results[1], results[0]];
            
            for (let i = 0; i < 2; i++) {
                const line = i === 0 ? diagonal1 : diagonal2;
                const symbolCounts = {};
                line.forEach(symbol => {
                    symbolCounts[symbol] = (symbolCounts[symbol] || 0) + 1;
                });
                
                for (const symbol in symbolCounts) {
                    const count = symbolCounts[symbol];
                    if (count >= 3 && payTable[symbol] && payTable[symbol][count]) {
                        const winAmount = payTable[symbol][count] * betAmount;
                        totalWin += winAmount;
                        winLines.push({
                            line: i === 0 ? 'Диагональ ↘' : 'Диагональ ↙',
                            symbol: symbol,
                            count: count,
                            win: winAmount
                        });
                    }
                }
            }
            
            // Обрабатываем выигрыш
            if (totalWin > 0) {
                balance += totalWin;
                lastWin = totalWin;
                jackpot += totalWin * 0.01; // Джекпот увеличивается на 1% от выигрыша
                
                // Показываем выигрыш
                showMessage(`🎉 Поздравляем! Вы выиграли ${totalWin.toFixed(2)} ₽!`);
                
                // Выделяем выигрышные слоты
                const slotElements = document.querySelectorAll('.slot');
                slotElements.forEach((slot, index) => {
                    if (results[index % 5] === results[0] && results[index % 5] !== '') {
                        slot.classList.add('win');
                        setTimeout(() => {
                            slot.classList.remove('win');
                        }, 1000);
                    }
                });
                
                // Проверяем шанс запуска мини-игры
                if (Math.random() < 0.35 || totalWin >= betAmount * 10) {
                    setTimeout(() => {
                        // Случайный выбор между мини-играми: 40% коробки, 60% дождь монет
                        if (Math.random() < 0.4) {
                            startMiniGame(totalWin * 1.2);
                        } else {
                            startCoinRainGame(totalWin * 1.2);
                        }
                    }, 2000);
                }
            } else {
                showMessage("Не повезло. Попробуйте еще раз!");
                
                // ДОПОЛНИТЕЛЬНЫЙ ШАНС мини-игры даже без выигрыша (15%)
                if (Math.random() < 0.15) {
                    setTimeout(() => {
                        // Чаще дождь монет при проигрыше
                        if (Math.random() < 0.7) {
                            startCoinRainGame(betAmount * 0.8); // Большая сумма для компенсации
                        } else {
                            startMiniGame(betAmount * 0.6);
                        }
                    }, 2000);
                }
            }
            
            // Обновляем UI
            updateUI();
        }

        function startMiniGame(bonusAmount) {
            const overlay = document.getElementById('miniGameOverlay');
            const miniGameMsg = document.getElementById('miniGameMsg');
            const boxes = document.querySelectorAll('.box');
            
            // Скрыть все предыдущие выигрыши
            boxes.forEach(box => {
                box.classList.remove('win-box');
            });
            
            // Показываем мини-игру
            overlay.style.display = 'flex';
            miniGameMsg.textContent = 'Выберите одну из коробок - в одной из них приз!';
            
            // Выбираем случайную коробку с призом
            const prizeBox = Math.floor(Math.random() * 3) + 1;
            
            // Добавляем обработчики для коробок
            boxes.forEach(box => {
                box.onclick = function() {
                    const selectedBox = parseInt(this.getAttribute('data-box'));
                    
                    // Отключаем все коробки
                    boxes.forEach(b => b.onclick = null);
                    
                    if (selectedBox === prizeBox) {
                        // Выигрыш
                        const winAmount = bonusAmount;
                        balance += winAmount;
                        miniGameMsg.textContent = `🎉 Поздравляем! Вы выиграли ${winAmount.toFixed(2)} ₽!`;
                        this.classList.add('win-box');
                        showMessage(`🎁 Поздравляем с бонусом! Вы выиграли ${winAmount.toFixed(2)} ₽!`);
                    } else {
                        // Проигрыш
                        miniGameMsg.textContent = `😔 К сожалению, приз был в другой коробке.`;
                    }
                    
                    // Закрываем мини-игру через 3 секунды
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        updateUI();
                    }, 3000);
                };
            });
        }

        function startCoinRainGame(bonusAmount) {
            const overlay = document.getElementById('coinRainOverlay');
            const canvas = document.getElementById('coinRainCanvas');
            const ctx = canvas.getContext('2d');
            const coinsCaughtElement = document.getElementById('coinsCaught');
            const timeLeftElement = document.getElementById('timeLeft');
            const resultElement = document.getElementById('coinRainResult');
            const resultTextElement = document.getElementById('coinRainResultText');
            const closeResultBtn = document.getElementById('coinRainClose');
            
            if (!overlay || !canvas || !ctx || !coinsCaughtElement || !timeLeftElement) {
                console.warn("Элементы мини-игры 'Дождь монет' не найдены.");
                return;
            }
            
            // Установка размеров canvas
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Игровые переменные
            const GAME_DURATION = 4000; // 4 секунды
            const COIN_VALUE = 5; // 5 рублей за монету
            const MAX_TOTAL_VALUE = 800; // максимум 800 рублей
            const MAX_COINS = Math.floor(MAX_TOTAL_VALUE / COIN_VALUE); // 160 монет
            let coins = [];
            let totalCaught = 0;
            let timeLeft = 4;
            let gameActive = true;
            
            // Класс монеты
            class Coin {
                constructor() {
                    this.radius = 15 + Math.random() * 10;
                    this.x = Math.random() * (canvas.width - this.radius * 2) + this.radius;
                    this.y = -this.radius;
                    this.speedY = 2 + Math.random() * 3;
                    this.speedX = (Math.random() - 0.5) * 4;
                    this.value = COIN_VALUE;
                    this.rotation = 0;
                    this.rotationSpeed = (Math.random() - 0.5) * 0.2;
                }
                
                update() {
                    this.y += this.speedY;
                    this.x += this.speedX;
                    this.rotation += this.rotationSpeed;
                    
                    // Падение монеты
                    if (this.y > canvas.height + this.radius) {
                        this.y = -this.radius;
                        this.x = Math.random() * (canvas.width - this.radius * 2) + this.radius;
                    }
                }
                
                draw() {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation);
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Рисуем текст внутри монеты
                    ctx.fillStyle = '#000';
                    ctx.font = 'bold ' + (this.radius * 0.6) + 'px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.value + '', 0, 0);
                    ctx.restore();
                }
            }
            
            // Создаем монеты
            for (let i = 0; i < MAX_COINS; i++) {
                coins.push(new Coin());
            }
            
            // Функция рисования
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Рисуем фон
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Рисуем монеты
                coins.forEach(coin => {
                    coin.draw();
                });
                
                // Рисуем текст
                ctx.fillStyle = '#FFD700';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`Поймано: ${totalCaught} ₽`, 20, 30);
                ctx.fillText(`Время: ${timeLeft} сек`, 20, 60);
            }
            
            // Функция обновления
            function update() {
                coins.forEach(coin => {
                    coin.update();
                });
                
                // Проверяем столкновения с игроком (простой вариант)
                // В реальной игре нужно реализовать правильную механику
            }
            
            // Функция игры
            function gameLoop() {
                if (!gameActive) return;
                
                update();
                draw();
                
                requestAnimationFrame(gameLoop);
            }
            
            // Запуск игры
            gameLoop();
            
            // Таймер для времени
            const timer = setInterval(() => {
                timeLeft--;
                timeLeftElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    endCoinRainGame();
                }
            }, 1000);
            
            // Функция завершения игры
            function endCoinRainGame() {
                gameActive = false;
                overlay.style.display = 'none';
                
                // Показываем результат
                resultTextElement.textContent = `🎉 Поздравляем! Вы заработали ${totalCaught} ₽!`;
                resultElement.style.display = 'block';
                
                // Добавляем выигрыш в баланс
                balance += totalCaught;
                updateUI();
                
                // Закрываем результат через 5 секунд
                setTimeout(() => {
                    resultElement.style.display = 'none';
                }, 5000);
            }
            
            // Обработчик кликов по монетам
            canvas.addEventListener('click', function(e) {
                if (!gameActive) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Проверяем столкновение с монетами
                coins.forEach(coin => {
                    const dx = x - coin.x;
                    const dy = y - coin.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < coin.radius) {
                        // Поймали монету
                        totalCaught += coin.value;
                        coinsCaughtElement.textContent = totalCaught;
                        
                        // Смещаем монету вниз
                        coin.y = canvas.height + coin.radius;
                        coin.x = Math.random() * (canvas.width - coin.radius * 2) + coin.radius;
                    }
                });
            });
            
            // Показываем игру
            overlay.style.display = 'flex';
            coinsCaughtElement.textContent = totalCaught;
            timeLeftElement.textContent = timeLeft;
            
            // Скрываем результат при старте
            resultElement.style.display = 'none';
        }

        function checkPaymentReturn() {
            const urlParams = new URLSearchParams(window.location.search);
            const payment = urlParams.get('payment');
            const amount = urlParams.get('amount');
            const id = urlParams.get('id');
            
            if (payment === 'success' && amount && id) {
                // Удаляем параметры из URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Проверяем, был ли этот платеж обработан
                const pendingPayment = JSON.parse(localStorage.getItem('pendingPayment') || '{}');
                if (pendingPayment.id === id && pendingPayment.amount == amount) {
                    // Платеж успешен
                    balance += parseInt(amount);
                    localStorage.setItem('local_slotBalance', balance);
                    updateUI();
                    showMessage(`✅ Платеж на ${amount} ₽ успешно обработан! Баланс пополнен.`);
                    
                    // Удаляем информацию о платеже
                    localStorage.removeItem('pendingPayment');
                }
            }
        }

        // Класс управления фриспинами
        class FreeSpinsManager {
            constructor() {
                this.freeSpins = localStorage.getItem('freeSpins') ? parseInt(localStorage.getItem('freeSpins')) : 0;
                this.lastFreeSpinsTime = localStorage.getItem('lastFreeSpinsTime') ? parseInt(localStorage.getItem('lastFreeSpinsTime')) : 0;
            }
            
            getFreeSpins() {
                // Проверяем, истек ли срок действия фриспинов (24 часа)
                const now = Date.now();
                const twentyFourHours = 24 * 60 * 60 * 1000;
                
                if (now - this.lastFreeSpinsTime > twentyFourHours) {
                    this.freeSpins = 0;
                    this.lastFreeSpinsTime = now;
                    this.save();
                }
                
                return this.freeSpins;
            }
            
            useFreeSpins(count) {
                if (this.freeSpins >= count) {
                    this.freeSpins -= count;
                    this.save();
                }
            }
            
            addFreeSpins(count) {
                this.freeSpins += count;
                this.lastFreeSpinsTime = Date.now();
                this.save();
            }
            
            save() {
                localStorage.setItem('freeSpins', this.freeSpins);
                localStorage.setItem('lastFreeSpinsTime', this.lastFreeSpinsTime);
            }
        }
    </script>
</body>
</html>
