<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BettBoom - Экстремальные слоты</title>
  <style>
    /* Полный CSS из вашего файла, включая стили игры, модальных окон и мини-игр */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .header {
      text-align: center;
      padding: 15px;
      background: rgba(0, 0, 0, 0.7);
      border-bottom: 2px solid gold;
    }
    .header h1 {
      margin: 0;
      font-size: 2rem;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
      animation: glow 2s infinite alternate;
    }
    @keyframes glow {
      from {text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);}
      to {text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.6);}
    }
    .game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      gap: 20px;
    }
    .user-info {
      display: flex;
      justify-content: space-around;
      width: 90%;
      max-width: 500px;
      background: rgba(0, 0, 0, 0.6);
      padding: 15px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .info-item {
      text-align: center;
    }
    .info-item span {
      color: var(--tg-theme-accent-text-color, #ffd700);
      font-weight: bold;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }
    .slot-machine {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
      width: 90%;
      max-width: 500px;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 15px;
      border: 2px solid gold;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }
    .slot {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    .slot.win {
      animation: winAnimation 0.5s ease-in-out;
      background: rgba(255, 215, 0, 0.2);
    }
    @keyframes winAnimation {
      0% {transform: scale(1);}
      50% {transform: scale(1.1);}
      100% {transform: scale(1);}
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      width: 90%;
      max-width: 500px;
    }
    button {
      padding: 12px 20px;
      font-size: 14px;
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }
    button:active {
      transform: translateY(0);
    }
    .replenish-btn {
      background: linear-gradient(45deg, #2196F3, #1976D2);
    }
    .auto-spin-btn {
      background: linear-gradient(45deg, #FF9800, #F57C00);
    }
    .stop-auto-btn {
      background: linear-gradient(45deg, #f44336, #d32f2f);
    }
    .message {
      margin: 15px 0;
      min-height: 2em;
      text-align: center;
      color: #ffeb3b;
      font-size: 14px;
      max-width: 90vw;
      word-wrap: break-word;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    #botChat {
      width: 90%;
      max-width: 400px;
      height: 80px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      padding: 10px;
      margin-top: 10px;
      overflow-y: auto;
      font-size: 11px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .bot-message {
      margin-bottom: 3px;
      color: #bbb;
    }
    .modal-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #333;
      padding: 25px;
      border-radius: 15px;
      color: white;
      min-width: 300px;
      max-width: 90vw;
      text-align: center;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .modal input {
      margin: 15px 0;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #555;
      width: 220px;
      background: #222;
      color: white;
    }
    .modal button {
      padding: 10px 20px;
      font-size: 14px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 6px;
    }
    .modal button.cancel {
      background: #f44336;
    }
    /* Улучшенное модальное окно пополнения */
    #inGameReplenishModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    /* Мини-игра "Дождь монет" */
    #coinRainOverlay {
      background: rgba(0, 0, 0, 0.95);
    }
    #coinRainCanvas {
      width: 100%;
      height: 100%;
      cursor: pointer;
      touch-action: manipulation;
    }
    #coinRainUI {
      position: absolute;
      top: 20px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 18px;
      color: var(--tg-theme-accent-text-color, #ffd700);
      z-index: 1001;
      pointer-events: none;
    }
    #coinRainTitle {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
      animation: coinRainTitlePulse 1s infinite alternate;
    }
    @keyframes coinRainTitlePulse {
      0% {transform: scale(1);}
      100% {transform: scale(1.05);}
    }
    #coinRainResult {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      color: var(--tg-theme-accent-text-color, #ffd700);
      z-index: 1002;
    }
    #coinRainResultText {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
    }
    #coinRainClose {
      padding: 12px 24px;
      font-size: 16px;
      background: var(--tg-theme-button-color, #4caf50);
      color: var(--tg-theme-button-text-color, white);
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .browser-notice {
      background: linear-gradient(135deg, #2196f3, #1565c0);
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 12px;
    }
    .win-animation {
      animation: winPulse 0.5s ease-in-out;
    }
    @keyframes winPulse {
      0% {transform: scale(1);}
      50% {transform: scale(1.1);}
      100% {transform: scale(1);}
    }
    .jackpot-info {
      color: gold;
      animation: jackpotGlow 2s ease-in-out infinite alternate;
    }
    @keyframes jackpotGlow {
      0% {box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);}
      100% {box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);}
    }
    .freespin-info {
      color: #4caf50;
    }
    /* Специальные стили для улучшения видимости */
    #usernameDisplay {
      color: var(--tg-theme-accent-text-color, #ffd700) !important;
      font-weight: bold;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }
    #balanceDisplay {
      color: var(--tg-theme-accent-text-color, #ffd700) !important;
      font-weight: bold;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }
    #betDisplay {
      color: var(--tg-theme-accent-text-color, #ffd700) !important;
      font-weight: bold;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }
    #betAmountDisplay {
      color: var(--tg-theme-accent-text-color, #ffd700) !important;
      font-weight: bold;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }
    .loading {
      opacity: 0;
      animation: fadeIn 0.8s ease-in-out forwards;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(30px);}
      to {opacity: 1; transform: translateY(0);}
    }
    @media (max-width: 360px) {
      .slot {
        font-size: 5vw;
      }
      .user-info {
        font-size: 11px;
      }
      button {
        font-size: 11px;
        padding: 10px 12px;
      }
    }
    /* Стили для мини-игр */
    .mini-game-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .mini-game-content {
      background: #333;
      padding: 25px;
      border-radius: 15px;
      color: white;
      text-align: center;
      border: 2px solid gold;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .boxes {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    .box {
      font-size: 3rem;
      cursor: pointer;
      padding: 20px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    .box:hover {
      transform: scale(1.1);
      background: rgba(255, 215, 0, 0.2);
    }
    .mini-game-msg {
      font-size: 1.2rem;
      margin: 20px 0;
    }
    .win-box {
      animation: boxWin 0.5s ease-in-out;
    }
    @keyframes boxWin {
      0% {transform: scale(1);}
      50% {transform: scale(1.2);}
      100% {transform: scale(1);}
    }
    .rules-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .rules-content {
      background: #333;
      padding: 25px;
      border-radius: 15px;
      color: white;
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .rules-content h3 {
      color: gold;
      text-align: center;
      margin-top: 0;
    }
    .rules-content p {
      line-height: 1.5;
    }
  </style>
</head>
<body class="loading">
  <div class="browser-notice" style="display:none;">
    🖥️ <strong>Локальная версия для тестирования</strong> • Игра полностью работает в браузере
  </div>
  <div class="header"><h1>💥 BettBoom</h1></div>
  <div class="game-container">
    <div class="user-info">
      <div class="info-item">Игрок: <span id="usernameDisplay">-</span></div>
      <div class="info-item">Баланс: <span id="balanceDisplay">0.00</span> ₽</div>
      <div class="info-item">Ставка: <span id="betAmountDisplay">100</span> ₽</div>
      <div class="info-item">Фриспины: <span id="freeSpinsDisplay" class="freespin-info">0</span></div>
      <div class="info-item">Джекпот: <span id="jackpotDisplay" class="jackpot-info">0.00</span> ₽</div>
    </div>
    <div class="slot-machine" id="slotMachine"></div>
    <div class="message" id="message">💥 Игра полностью исправлена и готова! Нажмите "Крутить"</div>
    <div id="botChat"><b>🔥 Активные игроки:</b><br></div>
    <div class="controls">
      <button id="spinButton">🎰 Крутить</button>
      <button id="autoSpinButton" class="auto-spin-btn">🔄 Авто</button>
      <button id="stopAutoButton" class="stop-auto-btn" style="display:none;">⏹️ Стоп</button>
      <button id="rulesButton">📖 Правила</button>
      <button id="withdrawBtn">💸 Вывод</button>
      <button class="replenish-btn" data-amount="500">💳 500 ₽</button>
      <button class="replenish-btn" data-amount="800">💳 800 ₽</button>
      <button class="replenish-btn" data-amount="1000">💳 1000 ₽</button>
      <button class="replenish-btn" data-amount="10000">💳 10000 ₽</button>
    </div>
    <div style="display:flex;gap:10px;margin-top:10px;">
      <button id="decreaseBet">-</button>
      <button id="increaseBet">+</button>
    </div>
  </div>

  <!-- Мини-игра "Выбери коробку" -->
  <div class="mini-game-overlay" id="miniGameOverlay">
    <div class="mini-game-content">
      <h3>🎁 Мини-игра: выберите коробку!</h3>
      <div class="boxes">
        <div class="box" data-box="1">🎁</div>
        <div class="box" data-box="2">🎁</div>
        <div class="box" data-box="3">🎁</div>
      </div>
      <div class="mini-game-msg" id="miniGameMsg">Выберите одну из коробок - в одной из них приз!</div>
    </div>
  </div>

  <!-- Мини-игра "Дождь монет" -->
  <div id="coinRainOverlay" class="mini-game-overlay" style="display:none;">
    <div id="coinRainUI">
      <div id="coinRainTitle">💰 Дождь монет 💰</div>
      <div>Поймано: <span id="coinsCaught">0</span> ₽</div>
      <div>Время: <span id="timeLeft">4</span> сек</div>
    </div>
    <canvas id="coinRainCanvas"></canvas>
    <div id="coinRainResult" style="display:none;">
      <div id="coinRainResultText"></div>
      <button id="coinRainClose">Забрать выигрыш</button>
    </div>
  </div>

  <!-- Модальное окно правил -->
  <div class="rules-modal" id="rulesModal">
    <div class="rules-content">
      <h3>📖 Правила игры</h3>
      <p>1. Играйте с минимальной ставкой 100 ₽</p>
      <p>2. Выигрыши зависят от комбинации символов на линии</p>
      <p>3. Джекпот увеличивается с каждой ставкой</p>
      <p>4. При выигрыше 3 или более одинаковых символов, вы получаете выигрыш</p>
      <p>5. Бесплатные спины активируются при выигрыше 3 или более "🎁"</p>
      <p>6. Мини-игры доступны по кнопке "Мини-игры"</p>
      <p>7. Все выигрыши можно вывести на свой кошелек</p>
      <p>8. Игра не требует регистрации</p>
      <p>9. Победители получают бонусы</p>
      <p>10. Придерживайтесь правил безопасности</p>
    </div>
  </div>

  <!-- Модальное окно пополнения -->
  <div class="modal-bg" id="inGameReplenishModal">
    <div class="modal">
      <h2>💳 Пополнение баланса</h2>
      <input type="number" id="replenishAmount" placeholder="Введите сумму" min="100" max="100000">
      <div>
        <button id="confirmReplenish">Подтвердить</button>
        <button class="cancel" id="cancelReplenish">Отмена</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно вывода -->
  <div class="modal-bg" id="withdrawModal">
    <div class="modal">
      <h2>💸 Вывод средств</h2>
      <p>Доступный баланс: <span id="availableBalance">0</span> ₽</p>
      <input type="number" id="withdrawAmount" placeholder="Введите сумму" min="100" max="100000">
      <div>
        <button id="confirmWithdraw">Вывести</button>
        <button class="cancel" id="cancelWithdraw">Отмена</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно ввода имени -->
  <div class="modal-bg" id="usernameModal">
    <div class="modal">
      <h2>👤 Введите ваше имя</h2>
      <input type="text" id="usernameInput" placeholder="Имя игрока">
      <div>
        <button id="confirmUsername">Продолжить</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно победы -->
  <div class="modal-bg" id="winModal">
    <div class="modal">
      <h2>🎉 Поздравляем!</h2>
      <p id="winMessage">Вы выиграли 5000 ₽!</p>
      <button id="closeWinModal">Продолжить</button>
    </div>
  </div>

  <script>
    // Игровые символы и таблица выплат
    const reels = [
      ["🍒","🍓","🍍","🥝","🍌","🥥","🎁","💎","🍒","🍋","🍊","🍉","🍇","🍓","🍍","🥝","⭐","🃏"],
      ["🍒","🍓","🍍","🥝","🍌","🥥","🎁","💎","🍒","🍋","🍊","🍉","🍇","🍓","🍍","🥝","⭐","🃏"],
      ["🍒","🍓","🍍","🥝","🍌","🥥","🎁","💎","🍒","🍋","🍊","🍉","🍇","🍓","🍍","🥝","⭐","🃏"],
      ["🍒","🍓","🍍","🥝","🍌","🥥","🎁","💎","🍒","🍋","🍊","🍉","🍇","🍓","🍍","🥝","⭐","🃏"],
      ["🍒","🍓","🍍","🥝","🍌","🥥","🎁","💎","🍒","🍋","🍊","🍉","🍇","🍓","🍍","🥝","⭐","🃏"]
    ];

    const payTable = {
      "🍒": {3:8, 4:15, 5:30},
      "🍋": {3:8, 4:15, 5:30},
      "🍊": {3:8, 4:15, 5:30},
      "🍉": {3:8, 4:15, 5:30},
      "🍇": {3:8, 4:15, 5:30},
      "🍓": {3:12, 4:20, 5:40},
      "🍍": {3:12, 4:20, 5:40},
      "🥝": {3:15, 4:30, 5:60},
      "🍌": {3:15, 4:30, 5:60},
      "🥥": {3:20, 4:40, 5:80},
      "🎁": {3:25, 4:50, 5:100},
      "💎": {3:30, 4:60, 5:120},
      "⭐": {3:40, 4:80, 5:160},
      "🃏": {3:50, 4:100, 5:200},
      "👑": {3:80, 4:160, 5:320},
      "💰": {3:150, 4:300, 5:800}
    };

    // Состояние игры
    let balance = parseFloat(localStorage.getItem('local_slotBalance')) || 5000;
    let betAmount = 100;
    let isSpinning = false;
    let isAutoSpinning = false;
    let autoSpinInterval;
    let username = localStorage.getItem('username') || '';
    let jackpot = 0;
    let lastWin = 0;
    let freeSpinsManager = new FreeSpinsManager();
    let botMessages = [
      "Поздравляем с новым игроком!",
      "Крутим слоты!",
      "Счастливый выигрыш!",
      "Приятной игры!",
      "Удачи!",
      "Бонус за ставку!",
      "Джекпот растет!",
      "Бесплатные спины активированы!",
      "Новый рекорд!",
      "Счастливый игрок!"
    ];
    let botChatInterval;

    // Класс для управления бесплатными спинами
    class FreeSpinsManager {
      constructor() {
        this.freeSpins = 0;
        this.multiplier = 1;
      }

      activateFreeSpins(count) {
        this.freeSpins = count;
        this.multiplier = 1;
      }

      useFreeSpin() {
        if (this.freeSpins > 0) {
          this.freeSpins--;
          return true;
        }
        return false;
      }

      isActive() {
        return this.freeSpins > 0;
      }

      getFreeSpins() {
        return this.freeSpins;
      }
    }

    // Инициализация игры
    function initGame() {
      // Проверяем, есть ли имя пользователя
      if (!username) {
        showUsernameModal();
      } else {
        updateUI();
        startBotChat();
      }
      
      // Создаем слоты
      createSlots();
      
      // Привязываем события
      bindEvents();
      
      // Запускаем таймер для обновления бот-чата
      setInterval(updateBotChat, 5000);
    }

    // Создание слотов
    function createSlots() {
      const slotMachine = document.getElementById('slotMachine');
      slotMachine.innerHTML = '';
      
      for (let i = 0; i < 5; i++) {
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.id = `slot-${i}`;
        slot.textContent = '❓';
        slotMachine.appendChild(slot);
      }
    }

    // Обновление интерфейса
    function updateUI() {
      document.getElementById('usernameDisplay').textContent = username;
      document.getElementById('balanceDisplay').textContent = balance.toFixed(2);
      document.getElementById('betAmountDisplay').textContent = betAmount;
      document.getElementById('freeSpinsDisplay').textContent = freeSpinsManager.getFreeSpins();
      document.getElementById('jackpotDisplay').textContent = jackpot.toFixed(2);
      
      // Обновляем цвета в зависимости от значений
      if (freeSpinsManager.isActive()) {
        document.getElementById('freeSpinsDisplay').className = 'freespin-info';
      } else {
        document.getElementById('freeSpinsDisplay').className = '';
      }
    }

    // Привязка событий
    function bindEvents() {
      document.getElementById('spinButton').addEventListener('click', spin);
      document.getElementById('autoSpinButton').addEventListener('click', startAutoSpin);
      document.getElementById('stopAutoButton').addEventListener('click', stopAutoSpin);
      document.getElementById('decreaseBet').addEventListener('click', () => changeBet(-100));
      document.getElementById('increaseBet').addEventListener('click', () => changeBet(100));
      document.getElementById('rulesButton').addEventListener('click', showRules);
      document.getElementById('withdrawBtn').addEventListener('click', showWithdrawModal);
      
      // Привязка событий к кнопкам пополнения
      document.querySelectorAll('.replenish-btn').forEach(button => {
        button.addEventListener('click', () => {
          const amount = parseInt(button.getAttribute('data-amount'));
          showReplenishModal(amount);
        });
      });
      
      // Привязка событий к мини-играм
      document.getElementById('miniGameOverlay').addEventListener('click', (e) => {
        if (e.target.classList.contains('box')) {
          chooseBox(e.target);
        }
      });
      
      // События для модальных окон
      document.getElementById('confirmUsername').addEventListener('click', confirmUsername);
      document.getElementById('confirmReplenish').addEventListener('click', confirmReplenish);
      document.getElementById('cancelReplenish').addEventListener('click', hideReplenishModal);
      document.getElementById('confirmWithdraw').addEventListener('click', confirmWithdraw);
      document.getElementById('cancelWithdraw').addEventListener('click', hideWithdrawModal);
      document.getElementById('closeWinModal').addEventListener('click', hideWinModal);
      document.getElementById('coinRainClose').addEventListener('click', hideCoinRain);
      
      // События для закрытия модальных окон по ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideAllModals();
        }
      });
    }

    // Запуск автоматического вращения
    function startAutoSpin() {
      if (isSpinning) return;
      
      isAutoSpinning = true;
      document.getElementById('autoSpinButton').style.display = 'none';
      document.getElementById('stopAutoButton').style.display = 'block';
      
      autoSpinInterval = setInterval(() => {
        spin();
      }, 1500);
    }

    // Остановка автоматического вращения
    function stopAutoSpin() {
      isAutoSpinning = false;
      clearInterval(autoSpinInterval);
      document.getElementById('autoSpinButton').style.display = 'block';
      document.getElementById('stopAutoButton').style.display = 'none';
    }

    // Изменение ставки
    function changeBet(amount) {
      if (isSpinning) return;
      
      betAmount += amount;
      if (betAmount < 100) betAmount = 100;
      if (betAmount > balance) betAmount = balance;
      
      updateUI();
    }

    // Вращение слотов
    function spin() {
      if (isSpinning || balance < betAmount) return;
      
      isSpinning = true;
      document.getElementById('spinButton').disabled = true;
      
      // Снимаем ставку
      balance -= betAmount;
      updateUI();
      
      // Получаем случайные символы для каждого слота
      const results = [];
      for (let i = 0; i < 5; i++) {
        const reel = reels[i];
        const randomIndex = Math.floor(Math.random() * reel.length);
        results.push(reel[randomIndex]);
      }
      
      // Анимация вращения
      animateSlotRotation(results);
    }

    // Анимация вращения слотов
    function animateSlotRotation(results) {
      const slots = document.querySelectorAll('.slot');
      let spins = 0;
      const maxSpins = 20;
      
      const spinInterval = setInterval(() => {
        // Обновляем слоты случайными символами
        slots.forEach((slot, index) => {
          const reel = reels[index];
          const randomIndex = Math.floor(Math.random() * reel.length);
          slot.textContent = reel[randomIndex];
        });
        
        spins++;
        
        if (spins >= maxSpins) {
          clearInterval(spinInterval);
          
          // Отображаем финальные результаты
          slots.forEach((slot, index) => {
            slot.textContent = results[index];
          });
          
          // Проверяем выигрыш
          checkWin(results);
        }
      }, 100);
    }

    // Проверка выигрыша
    function checkWin(results) {
      let totalWin = 0;
      let winLines = [];
      
      // Проверяем горизонтальные линии
      for (let row = 0; row < 3; row++) {
        const line = [];
        for (let col = 0; col < 5; col++) {
          line.push(results[col]);
        }
        
        const winResult = calculateLineWin(line, row);
        if (winResult.amount > 0) {
          totalWin += winResult.amount;
          winLines.push({
            line: row,
            symbols: line,
            amount: winResult.amount
          });
        }
      }
      
      // Проверяем диагональные линии
      const diagonal1 = [results[0], results[1], results[2], results[3], results[4]];
      const diagonal2 = [results[4], results[3], results[2], results[1], results[0]];
      
      const diag1Win = calculateLineWin(diagonal1, 3);
      const diag2Win = calculateLineWin(diagonal2, 4);
      
      if (diag1Win.amount > 0) {
        totalWin += diag1Win.amount;
        winLines.push({
          line: 3,
          symbols: diagonal1,
          amount: diag1Win.amount
        });
      }
      
      if (diag2Win.amount > 0) {
        totalWin += diag2Win.amount;
        winLines.push({
          line: 4,
          symbols: diagonal2,
          amount: diag2Win.amount
        });
      }
      
      // Обрабатываем бесплатные спины
      if (freeSpinsManager.isActive()) {
        totalWin *= freeSpinsManager.multiplier;
        freeSpinsManager.useFreeSpin();
      }
      
      // Обновляем баланс и джекпот
      balance += totalWin;
      jackpot += betAmount * 0.05; // 5% от ставки
      
      // Обновляем UI
      updateUI();
      
      // Подсвечиваем выигрышные слоты
      highlightWinningSlots(winLines);
      
      // Показываем сообщение о выигрыше
      if (totalWin > 0) {
        showMessage(`🎉 Вы выиграли ${totalWin.toFixed(2)} ₽!`);
        showWinModal(totalWin);
      } else {
        showMessage("😔 Попробуйте еще раз!");
      }
      
      // Проверяем бонусные символы для бесплатных спинов
      const bonusCount = results.filter(symbol => symbol === '🎁').length;
      if (bonusCount >= 3) {
        freeSpinsManager.activateFreeSpins(bonusCount + 2);
        showMessage(`🎁 Бесплатные спины активированы! (${bonusCount + 2} спинов)`);
        updateUI();
      }
      
      // Сбрасываем состояние вращения
      isSpinning = false;
      document.getElementById('spinButton').disabled = false;
    }

    // Расчет выигрыша для линии
    function calculateLineWin(line, lineNum) {
      let amount = 0;
      let symbolCount = {};
      
      // Подсчитываем количество каждого символа
      line.forEach(symbol => {
        symbolCount[symbol] = (symbolCount[symbol] || 0) + 1;
      });
      
      // Проверяем каждый символ
      for (const symbol in symbolCount) {
        const count = symbolCount[symbol];
        if (count >= 3 && payTable[symbol]) {
          amount += payTable[symbol][count] * betAmount;
        }
      }
      
      return { amount, line: lineNum };
    }

    // Подсветка выигрышных слотов
    function highlightWinningSlots(winLines) {
      const slots = document.querySelectorAll('.slot');
      
      // Сбрасываем подсветку
      slots.forEach(slot => slot.classList.remove('win'));
      
      // Подсвечиваем выигрышные слоты
      winLines.forEach(line => {
        const startIndex = line.line === 0 ? 0 : 
                         line.line === 1 ? 1 : 
                         line.line === 2 ? 2 : 
                         line.line === 3 ? 0 : 4;
        
        for (let i = 0; i < 5; i++) {
          if (line.symbols[i] !== undefined) {
            slots[startIndex + i].classList.add('win');
          }
        }
      });
    }

    // Показать сообщение
    function showMessage(text) {
      document.getElementById('message').textContent = text;
    }

    // Показать модальное окно победы
    function showWinModal(amount) {
      document.getElementById('winMessage').textContent = `🎉 Вы выиграли ${amount.toFixed(2)} ₽!`;
      document.getElementById('winModal').style.display = 'flex';
    }

    // Скрыть модальное окно победы
    function hideWinModal() {
      document.getElementById('winModal').style.display = 'none';
    }

    // Показать модальное окно ввода имени
    function showUsernameModal() {
      document.getElementById('usernameModal').style.display = 'flex';
    }

    // Подтвердить имя пользователя
    function confirmUsername() {
      const nameInput = document.getElementById('usernameInput');
      if (nameInput.value.trim() !== '') {
        username = nameInput.value.trim();
        localStorage.setItem('username', username);
        document.getElementById('usernameModal').style.display = 'none';
        updateUI();
        startBotChat();
      }
    }

    // Показать модальное окно пополнения
    function showReplenishModal(amount = null) {
      const replenishModal = document.getElementById('inGameReplenishModal');
      const amountInput = document.getElementById('replenishAmount');
      
      if (amount) {
        amountInput.value = amount;
      } else {
        amountInput.value = '';
      }
      
      replenishModal.style.display = 'flex';
    }

    // Скрыть модальное окно пополнения
    function hideReplenishModal() {
      document.getElementById('inGameReplenishModal').style.display = 'none';
    }

    // Подтвердить пополнение
    function confirmReplenish() {
      const amountInput = document.getElementById('replenishAmount');
      const amount = parseInt(amountInput.value);
      
      if (isNaN(amount) || amount < 100) {
        showMessage("Введите корректную сумму (минимум 100 ₽)");
        return;
      }
      
      balance += amount;
      updateUI();
      hideReplenishModal();
      showMessage(`✅ Баланс пополнен на ${amount} ₽!`);
    }

    // Показать модальное окно вывода
    function showWithdrawModal() {
      document.getElementById('availableBalance').textContent = balance.toFixed(2);
      document.getElementById('withdrawModal').style.display = 'flex';
    }

    // Скрыть модальное окно вывода
    function hideWithdrawModal() {
      document.getElementById('withdrawModal').style.display = 'none';
    }

    // Подтвердить вывод
    function confirmWithdraw() {
      const amountInput = document.getElementById('withdrawAmount');
      const amount = parseInt(amountInput.value);
      
      if (isNaN(amount) || amount < 100 || amount > balance) {
        showMessage("Введите корректную сумму (от 100 до " + balance.toFixed(2) + " ₽)");
        return;
      }
      
      balance -= amount;
      updateUI();
      hideWithdrawModal();
      showMessage(`✅ Вывод успешно оформлен на ${amount} ₽!`);
    }

    // Показать правила игры
    function showRules() {
      document.getElementById('rulesModal').style.display = 'flex';
    }

    // Показать мини-игру "Выбери коробку"
    function startMiniGame() {
      document.getElementById('miniGameOverlay').style.display = 'flex';
      document.getElementById('miniGameMsg').textContent = 'Выберите одну из коробок - в одной из них приз!';
    }

    // Выбор коробки в мини-игре
    function chooseBox(box) {
      const boxNumber = parseInt(box.getAttribute('data-box'));
      const winBox = Math.floor(Math.random() * 3) + 1;
      
      // Скрываем сообщение
      document.getElementById('miniGameMsg').textContent = '';
      
      // Подсвечиваем выбранную коробку
      box.classList.add('win-box');
      
      // Проверяем выигрыш
      if (boxNumber === winBox) {
        const winAmount = Math.floor(Math.random() * 5000) + 1000;
        balance += winAmount;
        updateUI();
        showMessage(`🎉 Поздравляем! Вы выиграли ${winAmount} ₽!`);
        document.getElementById('miniGameMsg').innerHTML = `<span style="color:#4caf50;">Вы выиграли ${winAmount} ₽!</span>`;
      } else {
        document.getElementById('miniGameMsg').innerHTML = '<span style="color:#f44336;">Не повезло! Попробуйте снова.</span>';
      }
      
      // Отключаем клики
      document.querySelectorAll('.box').forEach(b => b.style.pointerEvents = 'none');
    }

    // Запуск мини-игры "Дождь монет"
    function startCoinRainGame() {
      document.getElementById('coinRainOverlay').style.display = 'flex';
      document.getElementById('coinRainResult').style.display = 'none';
      document.getElementById('coinsCaught').textContent = '0';
      document.getElementById('timeLeft').textContent = '4';
      
      // Инициализируем канву
      const canvas = document.getElementById('coinRainCanvas');
      const ctx = canvas.getContext('2d');
      
      // Устанавливаем размеры канвы
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      
      // Монеты
      const coins = [];
      const coinSize = 20;
      let caughtCoins = 0;
      let timeLeft = 4;
      
      // Создаем монеты
      function createCoin() {
        return {
          x: Math.random() * (canvas.width - coinSize),
          y: -coinSize,
          size: coinSize,
          speed: Math.random() * 3 + 2,
          caught: false
        };
      }
      
      // Рисуем монету
      function drawCoin(coin) {
        ctx.beginPath();
        ctx.arc(coin.x + coin.size/2, coin.y + coin.size/2, coin.size/2, 0, Math.PI * 2);
        ctx.fillStyle = '#ffd700';
        ctx.fill();
        ctx.strokeStyle = '#ff9800';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // Рисуем текст на монете
        ctx.font = 'bold 10px Arial';
        ctx.fillStyle = '#000';
        ctx.textAlign = 'center';
        ctx.fillText('₽', coin.x + coin.size/2, coin.y + coin.size/2 + 3);
      }
      
      // Обновление позиций монет
      function updateCoins() {
        for (let i = coins.length - 1; i >= 0; i--) {
          coins[i].y += coins[i].speed;
          
          // Удаляем монеты, которые упали ниже экрана
          if (coins[i].y > canvas.height) {
            coins.splice(i, 1);
          }
        }
      }
      
      // Проверка столкновений
      function checkCollisions() {
        for (let i = coins.length - 1; i >= 0; i--) {
          if (coins[i].caught) continue;
          
          // Проверяем, если монета находится в области "ловушки"
          if (coins[i].y > canvas.height - 100 && coins[i].y < canvas.height) {
            coins[i].caught = true;
            caughtCoins += 100;
            document.getElementById('coinsCaught').textContent = caughtCoins;
          }
        }
      }
      
      // Основной цикл игры
      function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Создаем новые монеты
        if (Math.random() < 0.1) {
          coins.push(createCoin());
        }
        
        // Обновляем и рисуем монеты
        updateCoins();
        coins.forEach(drawCoin);
        
        // Проверяем столкновения
        checkCollisions();
        
        // Обновляем таймер
        if (timeLeft > 0) {
          timeLeft -= 0.01;
          document.getElementById('timeLeft').textContent = Math.ceil(timeLeft);
        } else {
          // Завершаем игру
          endCoinRainGame();
          return;
        }
        
        requestAnimationFrame(gameLoop);
      }
      
      // Завершение игры
      function endCoinRainGame() {
        const winAmount = caughtCoins;
        balance += winAmount;
        updateUI();
        
        document.getElementById('coinRainResultText').textContent = `Вы заработали ${winAmount} ₽!`;
        document.getElementById('coinRainResult').style.display = 'block';
      }
      
      // Запускаем игру
      gameLoop();
    }

    // Скрыть мини-игру "Дождь монет"
    function hideCoinRain() {
      document.getElementById('coinRainOverlay').style.display = 'none';
    }

    // Скрыть все модальные окна
    function hideAllModals() {
      document.querySelectorAll('.modal-bg, .mini-game-overlay').forEach(modal => {
        modal.style.display = 'none';
      });
    }

    // Запуск бот-чата
    function startBotChat() {
      if (botChatInterval) clearInterval(botChatInterval);
      
      botChatInterval = setInterval(() => {
        updateBotChat();
      }, 5000);
    }

    // Обновление бот-чата
    function updateBotChat() {
      const chat = document.getElementById('botChat');
      const message = botMessages[Math.floor(Math.random() * botMessages.length)];
      const now = new Date();
      const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                        now.getMinutes().toString().padStart(2, '0');
      
      chat.innerHTML += `<div class="bot-message">${timeString} ${message}</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    // Инициализация игры при загрузке страницы
    window.onload = initGame;
  </script>
</body>
</html>
